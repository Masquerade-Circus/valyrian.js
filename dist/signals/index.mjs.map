{
  "version": 3,
  "sources": ["../../lib/signals/index.ts"],
  "sourcesContent": ["import { current, DomElement, updateVnode, VnodeWithDom } from \"valyrian.js\";\nimport { get, set, hasChanged } from \"valyrian.js/utils\";\n\nconst effectStack: Function[] = [];\n\n// eslint-disable-next-line no-unused-vars\nexport type Signal<T> = [() => T, (newValue: T | ((current: T) => T)) => void, () => void];\n\nexport function createSignal<T>(initialValue: T): Signal<T> {\n  let value = initialValue;\n  const subscribers = new Set<Function>();\n  const domWithVnodesToUpdate = new WeakSet<DomElement>();\n\n  const runSubscribers = () => subscribers.forEach((subscriber) => subscriber());\n\n  const read = () => {\n    const currentEffect = effectStack[effectStack.length - 1];\n    if (currentEffect && !subscribers.has(currentEffect)) {\n      subscribers.add(currentEffect);\n    }\n\n    const currentVnode = current.vnode as VnodeWithDom;\n    if (currentVnode && !domWithVnodesToUpdate.has(currentVnode.dom)) {\n      const dom = currentVnode.dom;\n      const subscription = () => {\n        if (!dom.parentNode) {\n          subscribers.delete(subscription);\n          domWithVnodesToUpdate.delete(dom);\n          return;\n        }\n        updateVnode(dom.vnode);\n      };\n\n      subscribers.add(subscription);\n      domWithVnodesToUpdate.add(dom);\n    }\n\n    return value;\n  };\n\n  // eslint-disable-next-line no-unused-vars\n  const write = (newValue: T | ((current: T) => T)) => {\n    // eslint-disable-next-line no-unused-vars\n    const resolvedValue = typeof newValue === \"function\" ? (newValue as (current: T) => T)(value) : newValue;\n\n    if (current.event && !current.event.defaultPrevented) {\n      current.event.preventDefault();\n    }\n\n    if (!hasChanged(value, resolvedValue)) {\n      return;\n    }\n\n    value = resolvedValue;\n\n    runSubscribers();\n  };\n\n  return [read, write, runSubscribers];\n}\n\nconst effectDeps = new WeakMap<Function, any[]>();\n\nexport function createEffect(effect: Function, dependencies?: any[]) {\n  const runEffect = () => {\n    const oldDeps = effectDeps.get(effect);\n    const hasChangedDeps = !oldDeps || !dependencies || dependencies.some((dep, i) => !Object.is(dep, oldDeps[i]));\n\n    if (!hasChangedDeps) return;\n\n    effectDeps.set(effect, dependencies || []);\n    try {\n      effectStack.push(runEffect);\n      effect();\n    } finally {\n      effectStack.pop();\n    }\n  };\n\n  runEffect();\n}\n\n// Path is a string with dot notation, e.g:\n// 'a.b.c' === obj.a.b.c\n// 'a.0.c' === obj.a[0].c\n// eslint-disable-next-line no-unused-vars\nexport type SignalStore<T> = [() => T, (path: string, newValue: T | ((current: T) => T) | any) => void];\n\nexport function createSignalStore<T>(initialState: T): SignalStore<T> {\n  const [state, , runSubscribers] = createSignal(initialState);\n\n  // eslint-disable-next-line no-unused-vars\n  const setter = (path: string, newValue: T | ((current: T) => T)) => {\n    const current = get(initialState, path);\n    // eslint-disable-next-line no-unused-vars\n    const resolvedValue = typeof newValue === \"function\" ? (newValue as (current: T) => T)(current) : newValue;\n\n    if (!hasChanged(current, resolvedValue)) {\n      return;\n    }\n\n    set(initialState, path, resolvedValue);\n    runSubscribers();\n  };\n\n  return [state, setter];\n}\n"],
  "mappings": ";AAAA,SAAS,SAAqB,mBAAiC;AAC/D,SAAS,KAAK,KAAK,kBAAkB;AAErC,IAAM,cAA0B,CAAC;AAK1B,SAAS,aAAgB,cAA4B;AAC1D,MAAI,QAAQ;AACZ,QAAM,cAAc,oBAAI,IAAc;AACtC,QAAM,wBAAwB,oBAAI,QAAoB;AAEtD,QAAM,iBAAiB,MAAM,YAAY,QAAQ,CAAC,eAAe,WAAW,CAAC;AAE7E,QAAM,OAAO,MAAM;AACjB,UAAM,gBAAgB,YAAY,YAAY,SAAS,CAAC;AACxD,QAAI,iBAAiB,CAAC,YAAY,IAAI,aAAa,GAAG;AACpD,kBAAY,IAAI,aAAa;AAAA,IAC/B;AAEA,UAAM,eAAe,QAAQ;AAC7B,QAAI,gBAAgB,CAAC,sBAAsB,IAAI,aAAa,GAAG,GAAG;AAChE,YAAM,MAAM,aAAa;AACzB,YAAM,eAAe,MAAM;AACzB,YAAI,CAAC,IAAI,YAAY;AACnB,sBAAY,OAAO,YAAY;AAC/B,gCAAsB,OAAO,GAAG;AAChC;AAAA,QACF;AACA,oBAAY,IAAI,KAAK;AAAA,MACvB;AAEA,kBAAY,IAAI,YAAY;AAC5B,4BAAsB,IAAI,GAAG;AAAA,IAC/B;AAEA,WAAO;AAAA,EACT;AAGA,QAAM,QAAQ,CAAC,aAAsC;AAEnD,UAAM,gBAAgB,OAAO,aAAa,aAAc,SAA+B,KAAK,IAAI;AAEhG,QAAI,QAAQ,SAAS,CAAC,QAAQ,MAAM,kBAAkB;AACpD,cAAQ,MAAM,eAAe;AAAA,IAC/B;AAEA,QAAI,CAAC,WAAW,OAAO,aAAa,GAAG;AACrC;AAAA,IACF;AAEA,YAAQ;AAER,mBAAe;AAAA,EACjB;AAEA,SAAO,CAAC,MAAM,OAAO,cAAc;AACrC;AAEA,IAAM,aAAa,oBAAI,QAAyB;AAEzC,SAAS,aAAa,QAAkB,cAAsB;AACnE,QAAM,YAAY,MAAM;AACtB,UAAM,UAAU,WAAW,IAAI,MAAM;AACrC,UAAM,iBAAiB,CAAC,WAAW,CAAC,gBAAgB,aAAa,KAAK,CAAC,KAAK,MAAM,CAAC,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC;AAE7G,QAAI,CAAC,eAAgB;AAErB,eAAW,IAAI,QAAQ,gBAAgB,CAAC,CAAC;AACzC,QAAI;AACF,kBAAY,KAAK,SAAS;AAC1B,aAAO;AAAA,IACT,UAAE;AACA,kBAAY,IAAI;AAAA,IAClB;AAAA,EACF;AAEA,YAAU;AACZ;AAQO,SAAS,kBAAqB,cAAiC;AACpE,QAAM,CAAC,OAAO,EAAE,cAAc,IAAI,aAAa,YAAY;AAG3D,QAAM,SAAS,CAAC,MAAc,aAAsC;AAClE,UAAMA,WAAU,IAAI,cAAc,IAAI;AAEtC,UAAM,gBAAgB,OAAO,aAAa,aAAc,SAA+BA,QAAO,IAAI;AAElG,QAAI,CAAC,WAAWA,UAAS,aAAa,GAAG;AACvC;AAAA,IACF;AAEA,QAAI,cAAc,MAAM,aAAa;AACrC,mBAAe;AAAA,EACjB;AAEA,SAAO,CAAC,OAAO,MAAM;AACvB;",
  "names": ["current"]
}
