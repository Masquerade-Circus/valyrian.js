(()=>{"use strict";var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,o={};((t,n)=>{for(var r in n)e(t,r,{get:n[r],enumerable:!0})})(o,{createEffect:()=>h,createMutableStore:()=>d,createPulse:()=>y,createPulseStore:()=>p});var u,a=(u=o,((o,u,a,l)=>{if(u&&"object"==typeof u||"function"==typeof u)for(let s of n(u))r.call(o,s)||s===a||e(o,s,{get:()=>u[s],enumerable:!(l=t(u,s))||l.enumerable});return o})(e({},"__esModule",{value:!0}),u)),l=require("valyrian.js"),s=require("valyrian.js/utils"),c=[];function f(e,t){const n=l.current.vnode;if(!n||t.has(n.dom))return;let r=!1,o=n.dom.parentElement;for(;o;){if(t.has(o)){r=!0;break}o=o.parentElement}if(!r){const r=n.dom,o=()=>{(0,l.updateVnode)(r.vnode),r.parentElement||(e.delete(o),t.delete(r))};e.add(o),t.add(r)}}function i(e,t,n=!1){const r=new Set,o=new WeakSet,u={};for(const e in t){if("function"!=typeof t[e])throw new Error(`Pulse '${e}' must be a function`);if("state"===e)throw new Error("A pulse cannot be named 'state'");u[e]=P(e)}const a=("function"==typeof e?e():e)||{};function i(){if(n)throw new Error("You need to call a pulse to modify the state")}let p=null,d=0;const h=new Proxy(a,{get:(e,t)=>{if(p)return p[t];const n=c[c.length-1];return n&&!r.has(n)&&r.add(n),f(r,o),e[t]},set:(e,t,n)=>(i(),Reflect.set(e,t,n),!0),deleteProperty:(e,t)=>(i(),Reflect.deleteProperty(e,t),!0)});function y(e){for(const t in e)a[t]=n?(0,s.deepFreeze)(e[t]):e[t];for(const t in a)t in e||Reflect.deleteProperty(a,t)}let m=null;function w(e,t=!1){d--,d<=0&&!t&&(p=null,d=0),d>0&&!t||!(0,s.hasChanged)(a,e)||(y(e),m&&clearTimeout(m),m=setTimeout(()=>r.forEach(e=>e()),0))}function P(e){return function(...n){d++;const r=(null===p&&(p=(0,s.deepCloneUnfreeze)(a)),p),o=Object.create(t);o.$flush=()=>{p&&w(p,!0)};const u=()=>{},c=t=>{throw console.error(`Error in pulse '${e}':`,t),o.$flush=u,d--,d<=0&&(p=null,d=0),t};try{l.current.event&&(l.current.event.preventDefault(),l.current.event.stopImmediatePropagation());const a=t[e].apply(o,[r,...n]);return a instanceof Promise?a.then(e=>(w(r),o.$flush=u,e)).catch(c):(w(r),o.$flush=u,a)}catch(e){c(e)}}}y(a);const g={},b=(e,...t)=>{g[e]&&g[e].forEach(e=>e(...t))};return new Proxy(u,{get:(e,t)=>{if("state"===t)return h;if("on"===t)return(e,t)=>{g[e]||(g[e]=[]),g[e].push(t)};if("off"===t)return(e,t)=>{g[e]&&(g[e]=g[e].filter(e=>e!==t))};if(!(t in e))throw new Error(`Pulse '${t}' does not exist`);const n=e[t];return(...e)=>{const r=n.apply(n,e);return r instanceof Promise?r.then(n=>(b("pulse",t,e),n)):(b("pulse",t,e),r)}}})}function p(e,t){return i(e,t,!0)}function d(e,t){return console.warn("Warning: You are working with a mutable state. All state changes made outside of a pulse will not trigger a re-render."),i(e,t,!1)}function h(e){const t=()=>{try{c.push(t),e()}finally{c.pop()}};t()}function y(e){let t=e;const n=new Set,r=new WeakSet,o=()=>{n.forEach(e=>e())};return[()=>{const e=c[c.length-1];return e&&!n.has(e)&&n.add(e),f(n,r),t},e=>{const n="function"==typeof e?e(t):e;(0,s.hasChanged)(t,n)&&(t=n,o())},o]}"undefined"!=typeof module?module.exports=a:self.ValyrianPulses=a})();//# sourceMappingURL=index.min.js.map