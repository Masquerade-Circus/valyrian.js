{
  "version": 3,
  "sources": ["../../lib/network/index.ts"],
  "sourcesContent": ["import { isNodeJs } from \"valyrian.js\";\nimport { isFiniteNumber, isFunction, isString } from \"valyrian.js/utils\";\n\nexport type NetworkStatus = {\n  online: boolean;\n  effectiveType?: string;\n  downlink?: number;\n  rtt?: number;\n  saveData?: boolean;\n};\n\nexport type NetworkListener = (status: NetworkStatus) => void;\n\nexport enum NetworkEvent {\n  ONLINE = \"online\",\n  OFFLINE = \"offline\",\n  CHANGE = \"change\"\n}\n\nexport enum SignalLevel {\n  None = 0,\n  Poor = 1,\n  Fair = 2,\n  Good = 3,\n  Excellent = 4\n}\n\ntype NetworkConnection = {\n  effectiveType?: string;\n  downlink?: number;\n  rtt?: number;\n  saveData?: boolean;\n  addEventListener?: (event: string, listener: () => void) => void;\n  removeEventListener?: (event: string, listener: () => void) => void;\n};\n\ntype NavigatorLike = {\n  onLine: boolean;\n  connection?: NetworkConnection;\n  mozConnection?: NetworkConnection;\n  webkitConnection?: NetworkConnection;\n};\n\ntype WindowLike = {\n  addEventListener?: (event: string, listener: () => void) => void;\n  removeEventListener?: (event: string, listener: () => void) => void;\n};\n\nexport type NetworkManagerRuntime = {\n  isNodeJs?: boolean;\n  navigator?: NavigatorLike | null;\n  window?: WindowLike | null;\n};\n\nexport type NetworkManagerOptions = {\n  runtime?: NetworkManagerRuntime;\n};\n\nexport class NetworkError extends Error {}\n\nexport class NetworkManager {\n  #onlineListeners = new Set<NetworkListener>();\n  #offlineListeners = new Set<NetworkListener>();\n  #changeListeners = new Set<NetworkListener>();\n\n  #isNodeRuntime: boolean;\n  #navigator: NavigatorLike | null;\n  #window: WindowLike | null;\n\n  #onlineHandler = () => this.notifyListeners(NetworkEvent.ONLINE);\n  #offlineHandler = () => this.notifyListeners(NetworkEvent.OFFLINE);\n  #changeHandler = () => this.notifyListeners(NetworkEvent.CHANGE);\n\n  NetworkEvent = NetworkEvent;\n\n  constructor(options: NetworkManagerOptions = {}) {\n    const runtime = options.runtime || {};\n\n    this.#isNodeRuntime = runtime.isNodeJs ?? isNodeJs;\n    this.#navigator = runtime.navigator ?? ((globalThis.navigator as NavigatorLike | undefined) || null);\n    this.#window = runtime.window ?? ((globalThis.window as WindowLike | undefined) || null);\n\n    if (this.#isNodeRuntime || !this.#window || !this.#navigator) {\n      return;\n    }\n\n    if (isFunction(this.#window.addEventListener)) {\n      this.#window.addEventListener(NetworkEvent.ONLINE, this.#onlineHandler);\n      this.#window.addEventListener(NetworkEvent.OFFLINE, this.#offlineHandler);\n    }\n\n    try {\n      const connection = this.getConnection();\n      if (isFunction(connection.addEventListener)) {\n        connection.addEventListener(NetworkEvent.CHANGE, this.#changeHandler);\n      }\n    } catch {\n      // Network Information API not available\n    }\n  }\n\n  private getConnection(): NetworkConnection {\n    if (!this.#navigator) {\n      throw new NetworkError(\"Navigator not available\");\n    }\n\n    const connection = this.#navigator.connection || this.#navigator.mozConnection || this.#navigator.webkitConnection;\n\n    if (!connection) {\n      throw new NetworkError(\"Connection not available\");\n    }\n\n    return connection;\n  }\n\n  getNetworkStatus(): NetworkStatus {\n    if (this.#isNodeRuntime || !this.#navigator) {\n      return { online: true };\n    }\n\n    const online = this.#navigator.onLine;\n\n    try {\n      const connection = this.getConnection();\n      return {\n        online,\n        effectiveType: isString(connection.effectiveType) ? connection.effectiveType : undefined,\n        downlink: isFiniteNumber(connection.downlink) ? connection.downlink : undefined,\n        rtt: isFiniteNumber(connection.rtt) ? connection.rtt : undefined,\n        saveData: connection.saveData === true\n      };\n    } catch {\n      return { online };\n    }\n  }\n\n  getSignalLevel(): SignalLevel {\n    const status = this.getNetworkStatus();\n\n    if (!status.online) {\n      return SignalLevel.None;\n    }\n\n    if (status.effectiveType === \"slow-2g\") {\n      return SignalLevel.None;\n    }\n\n    if (!status.effectiveType) {\n      return SignalLevel.Good;\n    }\n\n    if (status.effectiveType === \"4g\") {\n      if (\n        isFiniteNumber(status.downlink) &&\n        status.downlink > 5 &&\n        isFiniteNumber(status.rtt) &&\n        status.rtt < 100\n      ) {\n        return SignalLevel.Excellent;\n      }\n      if (isFiniteNumber(status.downlink) && status.downlink >= 2) {\n        return SignalLevel.Good;\n      }\n      return SignalLevel.Fair;\n    }\n\n    if (status.effectiveType === \"3g\") {\n      if (isFiniteNumber(status.downlink) && status.downlink >= 1) {\n        return SignalLevel.Fair;\n      }\n      return SignalLevel.Poor;\n    }\n\n    return SignalLevel.Poor;\n  }\n\n  isConnectionPoor() {\n    return this.getSignalLevel() === SignalLevel.None;\n  }\n\n  getStatus() {\n    return this.getNetworkStatus();\n  }\n\n  private notifyListeners(event: NetworkEvent) {\n    const status = this.getNetworkStatus();\n    const listeners = this.getListeners(event);\n    for (const listener of listeners) {\n      listener(status);\n    }\n  }\n\n  private getListeners(event: NetworkEvent) {\n    switch (event) {\n      case NetworkEvent.ONLINE:\n        return this.#onlineListeners;\n      case NetworkEvent.OFFLINE:\n        return this.#offlineListeners;\n      case NetworkEvent.CHANGE:\n        return this.#changeListeners;\n      default:\n        throw new NetworkError(\"Invalid event type\");\n    }\n  }\n\n  on(event: NetworkEvent, listener: NetworkListener) {\n    this.getListeners(event).add(listener);\n    return () => this.off(event, listener);\n  }\n\n  off(event: NetworkEvent, listener: NetworkListener) {\n    this.getListeners(event).delete(listener);\n  }\n\n  destroy() {\n    if (!this.#isNodeRuntime) {\n      if (this.#window && isFunction(this.#window.removeEventListener)) {\n        this.#window.removeEventListener(NetworkEvent.ONLINE, this.#onlineHandler);\n        this.#window.removeEventListener(NetworkEvent.OFFLINE, this.#offlineHandler);\n      }\n\n      try {\n        const connection = this.getConnection();\n        if (isFunction(connection.removeEventListener)) {\n          connection.removeEventListener(NetworkEvent.CHANGE, this.#changeHandler);\n        }\n      } catch {\n        // Network Information API not available\n      }\n    }\n\n    this.#onlineListeners.clear();\n    this.#offlineListeners.clear();\n    this.#changeListeners.clear();\n  }\n}\n"],
  "mappings": "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",
  "names": ["NetworkEvent", "SignalLevel"]
}
