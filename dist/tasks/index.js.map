{
  "version": 3,
  "sources": ["../../lib/tasks/index.ts"],
  "sourcesContent": ["export type TaskStatus = \"idle\" | \"running\" | \"success\" | \"error\" | \"cancelled\";\nexport type TaskStrategy = \"takeLatest\" | \"enqueue\" | \"drop\" | \"restartable\";\n\nexport type TaskState<TResult> = {\n  status: TaskStatus;\n  running: boolean;\n  result: TResult | null;\n  error: unknown;\n};\n\nexport type TaskContext = {\n  signal: AbortSignal;\n};\n\nexport type TaskOptions<TArgs, TResult> = {\n  strategy?: TaskStrategy;\n  onSuccess?: (result: TResult, args: TArgs) => void;\n  onError?: (error: unknown, args: TArgs) => void;\n};\n\nexport type TaskHandler<TArgs, TResult> = (args: TArgs, ctx: TaskContext) => Promise<TResult> | TResult;\n\ntype TaskEventMap<TArgs, TResult> = {\n  state: Readonly<TaskState<TResult>>;\n  success: TResult;\n  error: unknown;\n  cancel: TArgs;\n};\n\ntype TaskListeners<TArgs, TResult> = {\n  [K in keyof TaskEventMap<TArgs, TResult>]: Set<(payload: TaskEventMap<TArgs, TResult>[K]) => void>;\n};\n\nfunction cloneState<TResult>(state: TaskState<TResult>): Readonly<TaskState<TResult>> {\n  return Object.freeze({ ...state });\n}\n\nexport class Task<TArgs = void, TResult = unknown> {\n  #handler: TaskHandler<TArgs, TResult>;\n  #options: TaskOptions<TArgs, TResult>;\n  #strategy: TaskStrategy;\n\n  #state: TaskState<TResult> = {\n    status: \"idle\",\n    running: false,\n    result: null,\n    error: null\n  };\n\n  #activeAbortController: AbortController | null = null;\n  #activeExecutionId = 0;\n  #queue: Promise<TResult | null> = Promise.resolve(null);\n  #abortCause: \"cancel\" | \"reset\" | null = null;\n\n  #listeners: TaskListeners<TArgs, TResult> = {\n    state: new Set(),\n    success: new Set(),\n    error: new Set(),\n    cancel: new Set()\n  };\n\n  constructor(handler: TaskHandler<TArgs, TResult>, options: TaskOptions<TArgs, TResult> = {}) {\n    this.#handler = handler;\n    this.#options = options;\n    this.#strategy = options.strategy || \"takeLatest\";\n  }\n\n  get state() {\n    return cloneState(this.#state);\n  }\n\n  data() {\n    return this.#state.result;\n  }\n\n  error() {\n    return this.#state.error;\n  }\n\n  on<K extends keyof TaskEventMap<TArgs, TResult>>(\n    event: K,\n    callback: (payload: TaskEventMap<TArgs, TResult>[K]) => void\n  ) {\n    this.#listeners[event].add(callback);\n    return () => this.off(event, callback);\n  }\n\n  off<K extends keyof TaskEventMap<TArgs, TResult>>(\n    event: K,\n    callback: (payload: TaskEventMap<TArgs, TResult>[K]) => void\n  ) {\n    this.#listeners[event].delete(callback);\n  }\n\n  #emit<K extends keyof TaskEventMap<TArgs, TResult>>(event: K, payload: TaskEventMap<TArgs, TResult>[K]) {\n    for (const listener of this.#listeners[event]) {\n      listener(payload);\n    }\n  }\n\n  #setState(next: Partial<TaskState<TResult>>) {\n    Object.assign(this.#state, next);\n    this.#emit(\"state\", cloneState(this.#state));\n  }\n\n  async #runWithArgs(args: TArgs): Promise<TResult | null> {\n    this.#activeExecutionId += 1;\n    const executionId = this.#activeExecutionId;\n\n    if (this.#strategy === \"takeLatest\" || this.#strategy === \"restartable\") {\n      this.#activeAbortController?.abort();\n    }\n\n    this.#activeAbortController = new AbortController();\n    const { signal } = this.#activeAbortController;\n\n    this.#setState({ status: \"running\", running: true, error: null });\n\n    try {\n      const result = await this.#handler(args, { signal });\n\n      if (signal.aborted) {\n        if (executionId === this.#activeExecutionId && this.#abortCause !== \"reset\") {\n          this.#setState({ status: \"cancelled\", running: false });\n          this.#emit(\"cancel\", args);\n        }\n        this.#abortCause = null;\n        return this.#state.result;\n      }\n\n      if (this.#strategy === \"takeLatest\" && executionId !== this.#activeExecutionId) {\n        return this.#state.result;\n      }\n\n      this.#setState({ status: \"success\", running: false, result });\n      this.#options.onSuccess?.(result, args);\n      this.#emit(\"success\", result);\n      this.#abortCause = null;\n      return result;\n    } catch (error) {\n      if (signal.aborted) {\n        if (executionId === this.#activeExecutionId && this.#abortCause !== \"reset\") {\n          this.#setState({ status: \"cancelled\", running: false });\n          this.#emit(\"cancel\", args);\n        }\n        this.#abortCause = null;\n        return this.#state.result;\n      }\n\n      this.#setState({ status: \"error\", running: false, error });\n      this.#options.onError?.(error, args);\n      this.#emit(\"error\", error);\n      this.#abortCause = null;\n      throw error;\n    }\n  }\n\n  run(args: TArgs): Promise<TResult | null> {\n    if (this.#strategy === \"drop\" && this.#state.running) {\n      return Promise.resolve(this.#state.result);\n    }\n\n    if (this.#strategy === \"enqueue\") {\n      this.#queue = this.#queue.catch(() => null).then(() => this.#runWithArgs(args));\n      return this.#queue;\n    }\n\n    return this.#runWithArgs(args);\n  }\n\n  cancel() {\n    if (!this.#activeAbortController) {\n      return;\n    }\n\n    if (!this.#abortCause) {\n      this.#abortCause = \"cancel\";\n    }\n    this.#activeAbortController.abort();\n    this.#setState({ status: \"cancelled\", running: false });\n  }\n\n  reset() {\n    this.cancel();\n    this.#abortCause = \"reset\";\n    this.#setState({\n      status: \"idle\",\n      running: false,\n      error: null,\n      result: null\n    });\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
