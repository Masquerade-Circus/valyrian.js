{
  "version": 3,
  "sources": ["../../lib/context/index.ts"],
  "sourcesContent": ["import { isNodeJs } from \"valyrian.js\";\n\ntype ScopeMap = Map<symbol, unknown>;\n\nconst NODE_CONTEXT_STORE_KEY = \"__valyrian_context_values__\";\nconst browserContextStore: ScopeMap = new Map();\n\nexport type ContextScope<T> = {\n  key: symbol;\n  name: string;\n  // Type marker only\n  __type?: T;\n};\n\nexport function createContextScope<T>(name: string): ContextScope<T> {\n  return {\n    key: Symbol(name),\n    name\n  };\n}\n\nfunction getNodeStoreObject(): Record<string | symbol, unknown> | null {\n  if (!isNodeJs || typeof sessionStorage === \"undefined\") {\n    return null;\n  }\n\n  const storage = sessionStorage as Storage & {\n    store?: Record<string | symbol, unknown>;\n  };\n\n  if (!storage.store || typeof storage.store !== \"object\") {\n    return null;\n  }\n\n  return storage.store;\n}\n\nfunction getScopeMap(create = false): ScopeMap | null {\n  const nodeStore = getNodeStoreObject();\n  if (nodeStore) {\n    const existingMap = nodeStore[NODE_CONTEXT_STORE_KEY] as ScopeMap | undefined;\n    if (existingMap) {\n      return existingMap;\n    }\n\n    if (create) {\n      const nextMap: ScopeMap = new Map();\n      nodeStore[NODE_CONTEXT_STORE_KEY] = nextMap;\n      return nextMap;\n    }\n\n    return null;\n  }\n\n  if (create) {\n    return browserContextStore;\n  }\n\n  return browserContextStore.size > 0 ? browserContextStore : null;\n}\n\nexport function isServerContextActive() {\n  if (!isNodeJs || typeof sessionStorage === \"undefined\") {\n    return false;\n  }\n\n  const maybeServerStorage = sessionStorage as Storage & {\n    isContextActive?: () => boolean;\n  };\n\n  if (typeof maybeServerStorage.isContextActive === \"function\") {\n    return Boolean(maybeServerStorage.isContextActive());\n  }\n\n  return false;\n}\n\nexport function getContext<T>(scope: ContextScope<T>): T | undefined {\n  const map = getScopeMap(false);\n  if (!map) {\n    return undefined;\n  }\n\n  return map.get(scope.key) as T | undefined;\n}\n\nexport function hasContext<T>(scope: ContextScope<T>): boolean {\n  const map = getScopeMap(false);\n  if (!map) {\n    return false;\n  }\n\n  return map.has(scope.key);\n}\n\nexport function setContext<T>(scope: ContextScope<T>, value: T): () => void {\n  const map = getScopeMap(true) as ScopeMap;\n  const hasPrevious = map.has(scope.key);\n  const previousValue = map.get(scope.key);\n\n  map.set(scope.key, value);\n\n  return () => {\n    if (!hasPrevious) {\n      map.delete(scope.key);\n      return;\n    }\n    map.set(scope.key, previousValue);\n  };\n}\n\nexport function runWithContext<T, TResult>(scope: ContextScope<T>, value: T, callback: () => TResult): TResult;\nexport function runWithContext<T, TResult>(\n  scope: ContextScope<T>,\n  value: T,\n  callback: () => Promise<TResult>\n): Promise<TResult>;\nexport function runWithContext<T, TResult>(\n  scope: ContextScope<T>,\n  value: T,\n  callback: () => TResult | Promise<TResult>\n) {\n  const restore = setContext(scope, value);\n  try {\n    const result = callback();\n    if (result instanceof Promise) {\n      return result.finally(restore);\n    }\n    restore();\n    return result;\n  } catch (error) {\n    restore();\n    throw error;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAAyB;AAIzB,IAAM,yBAAyB;AAC/B,IAAM,sBAAgC,oBAAI,IAAI;AASvC,SAAS,mBAAsB,MAA+B;AACnE,SAAO;AAAA,IACL,KAAK,OAAO,IAAI;AAAA,IAChB;AAAA,EACF;AACF;AAEA,SAAS,qBAA8D;AACrE,MAAI,CAAC,4BAAY,OAAO,mBAAmB,aAAa;AACtD,WAAO;AAAA,EACT;AAEA,QAAM,UAAU;AAIhB,MAAI,CAAC,QAAQ,SAAS,OAAO,QAAQ,UAAU,UAAU;AACvD,WAAO;AAAA,EACT;AAEA,SAAO,QAAQ;AACjB;AAEA,SAAS,YAAY,SAAS,OAAwB;AACpD,QAAM,YAAY,mBAAmB;AACrC,MAAI,WAAW;AACb,UAAM,cAAc,UAAU,sBAAsB;AACpD,QAAI,aAAa;AACf,aAAO;AAAA,IACT;AAEA,QAAI,QAAQ;AACV,YAAM,UAAoB,oBAAI,IAAI;AAClC,gBAAU,sBAAsB,IAAI;AACpC,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,EACT;AAEA,MAAI,QAAQ;AACV,WAAO;AAAA,EACT;AAEA,SAAO,oBAAoB,OAAO,IAAI,sBAAsB;AAC9D;AAEO,SAAS,wBAAwB;AACtC,MAAI,CAAC,4BAAY,OAAO,mBAAmB,aAAa;AACtD,WAAO;AAAA,EACT;AAEA,QAAM,qBAAqB;AAI3B,MAAI,OAAO,mBAAmB,oBAAoB,YAAY;AAC5D,WAAO,QAAQ,mBAAmB,gBAAgB,CAAC;AAAA,EACrD;AAEA,SAAO;AACT;AAEO,SAAS,WAAc,OAAuC;AACnE,QAAM,MAAM,YAAY,KAAK;AAC7B,MAAI,CAAC,KAAK;AACR,WAAO;AAAA,EACT;AAEA,SAAO,IAAI,IAAI,MAAM,GAAG;AAC1B;AAEO,SAAS,WAAc,OAAiC;AAC7D,QAAM,MAAM,YAAY,KAAK;AAC7B,MAAI,CAAC,KAAK;AACR,WAAO;AAAA,EACT;AAEA,SAAO,IAAI,IAAI,MAAM,GAAG;AAC1B;AAEO,SAAS,WAAc,OAAwB,OAAsB;AAC1E,QAAM,MAAM,YAAY,IAAI;AAC5B,QAAM,cAAc,IAAI,IAAI,MAAM,GAAG;AACrC,QAAM,gBAAgB,IAAI,IAAI,MAAM,GAAG;AAEvC,MAAI,IAAI,MAAM,KAAK,KAAK;AAExB,SAAO,MAAM;AACX,QAAI,CAAC,aAAa;AAChB,UAAI,OAAO,MAAM,GAAG;AACpB;AAAA,IACF;AACA,QAAI,IAAI,MAAM,KAAK,aAAa;AAAA,EAClC;AACF;AAQO,SAAS,eACd,OACA,OACA,UACA;AACA,QAAM,UAAU,WAAW,OAAO,KAAK;AACvC,MAAI;AACF,UAAM,SAAS,SAAS;AACxB,QAAI,kBAAkB,SAAS;AAC7B,aAAO,OAAO,QAAQ,OAAO;AAAA,IAC/B;AACA,YAAQ;AACR,WAAO;AAAA,EACT,SAAS,OAAO;AACd,YAAQ;AACR,UAAM;AAAA,EACR;AACF;",
  "names": []
}
