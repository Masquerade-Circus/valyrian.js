{
  "version": 3,
  "sources": ["../../lib/sw/index.ts"],
  "sourcesContent": ["import { isNodeJs } from \"valyrian.js\";\nimport { isFunction } from \"valyrian.js/utils\";\n\nexport type SwRuntimeEvent = \"registered\" | \"updateavailable\" | \"updated\" | \"error\";\n\nexport type SwRuntimeState = {\n  updateAvailable: boolean;\n  installing: boolean;\n  registration: ServiceWorkerRegistration | null;\n  waiting: ServiceWorker | null;\n};\n\nexport type SwRuntimeEnvironment = {\n  isNodeJs?: boolean;\n  navigator?: Navigator | null;\n  window?: Window | null;\n};\n\nexport type CreateSwRuntimeOptions = {\n  swUrl?: string;\n  scope?: string;\n  strategy?: \"prompt-user\" | \"auto\" | \"manual\";\n  runtime?: SwRuntimeEnvironment;\n};\n\nexport interface SwRuntime {\n  state: Readonly<SwRuntimeState>;\n  on: (event: SwRuntimeEvent, callback: (payload?: unknown) => void) => () => void;\n  off: (event: SwRuntimeEvent, callback: (payload?: unknown) => void) => void;\n  applyUpdate: () => void;\n  checkForUpdate: () => Promise<void>;\n  unregister: () => Promise<boolean>;\n}\n\ntype ListenerMap = {\n  [K in SwRuntimeEvent]: Set<(payload?: unknown) => void>;\n};\n\nfunction cloneState(state: SwRuntimeState): Readonly<SwRuntimeState> {\n  return Object.freeze({ ...state });\n}\n\nfunction hasServiceWorker(navigatorRef: Navigator | null): navigatorRef is Navigator & {\n  serviceWorker: ServiceWorkerContainer;\n} {\n  return Boolean(navigatorRef && \"serviceWorker\" in navigatorRef);\n}\n\nexport async function registerSw(\n  file = \"./sw.js\",\n  options: RegistrationOptions = { scope: \"/\" },\n  navigatorRef: Navigator | null = globalThis.navigator || null\n) {\n  if (!hasServiceWorker(navigatorRef)) {\n    return;\n  }\n\n  return navigatorRef.serviceWorker.register(file, options);\n}\n\nexport class SwRuntimeManager implements SwRuntime {\n  #swUrl: string;\n  #scope: string;\n  #strategy: \"prompt-user\" | \"auto\" | \"manual\";\n\n  #isNodeRuntime: boolean;\n  #navigator: Navigator | null;\n  #window: Window | null;\n\n  #state: SwRuntimeState = {\n    updateAvailable: false,\n    installing: false,\n    registration: null,\n    waiting: null\n  };\n\n  #listeners: ListenerMap = {\n    registered: new Set(),\n    updateavailable: new Set(),\n    updated: new Set(),\n    error: new Set()\n  };\n\n  #controllerChangeHandler = () => {\n    this.#state.updateAvailable = false;\n    this.#state.waiting = null;\n    this.#emit(\"updated\");\n\n    if (this.#strategy !== \"manual\" && isFunction(this.#window?.location?.reload)) {\n      this.#window!.location.reload();\n    }\n  };\n\n  constructor(options: CreateSwRuntimeOptions = {}) {\n    const runtime = options.runtime || {};\n\n    this.#swUrl = options.swUrl || \"./sw.js\";\n    this.#scope = options.scope || \"/\";\n    this.#strategy = options.strategy || \"prompt-user\";\n\n    this.#isNodeRuntime = runtime.isNodeJs ?? isNodeJs;\n    this.#navigator = runtime.navigator ?? globalThis.navigator ?? null;\n    this.#window = runtime.window ?? globalThis.window ?? null;\n  }\n\n  get state() {\n    return cloneState(this.#state);\n  }\n\n  on(event: SwRuntimeEvent, callback: (payload?: unknown) => void) {\n    this.#listeners[event].add(callback);\n    return () => this.off(event, callback);\n  }\n\n  off(event: SwRuntimeEvent, callback: (payload?: unknown) => void) {\n    this.#listeners[event].delete(callback);\n  }\n\n  #emit(event: SwRuntimeEvent, payload?: unknown) {\n    for (const callback of this.#listeners[event]) {\n      callback(payload);\n    }\n  }\n\n  #isSupported() {\n    return !this.#isNodeRuntime && hasServiceWorker(this.#navigator);\n  }\n\n  async init() {\n    if (!this.#isSupported()) {\n      return this;\n    }\n\n    try {\n      const registration = await registerSw(this.#swUrl, { scope: this.#scope }, this.#navigator);\n      if (!registration) {\n        return this;\n      }\n\n      this.#state.registration = registration;\n      this.#state.waiting = registration.waiting || null;\n      this.#state.updateAvailable = Boolean(registration.waiting);\n      this.#emit(\"registered\", registration);\n\n      if (this.#strategy === \"auto\" && this.#state.waiting) {\n        this.applyUpdate();\n      }\n\n      registration.addEventListener(\"updatefound\", () => {\n        this.#state.installing = true;\n        const installing = registration.installing;\n        if (!installing) {\n          return;\n        }\n\n        installing.addEventListener(\"statechange\", () => {\n          if (installing.state !== \"installed\") {\n            return;\n          }\n\n          this.#state.installing = false;\n          const serviceWorker = this.#navigator?.serviceWorker;\n          if (serviceWorker?.controller) {\n            this.#state.waiting = registration.waiting || installing;\n            this.#state.updateAvailable = true;\n            this.#emit(\"updateavailable\", { waiting: this.#state.waiting });\n\n            if (this.#strategy === \"auto\") {\n              this.applyUpdate();\n            }\n          }\n        });\n      });\n\n      this.#navigator!.serviceWorker.addEventListener(\"controllerchange\", this.#controllerChangeHandler);\n    } catch (error) {\n      this.#emit(\"error\", error);\n    }\n\n    return this;\n  }\n\n  applyUpdate() {\n    if (!this.#state.waiting) {\n      return;\n    }\n\n    this.#state.waiting.postMessage({ type: \"SKIP_WAITING\" });\n  }\n\n  async checkForUpdate() {\n    if (!this.#state.registration) {\n      return;\n    }\n\n    await this.#state.registration.update();\n  }\n\n  async unregister() {\n    if (!this.#state.registration) {\n      return false;\n    }\n\n    if (this.#isSupported()) {\n      const serviceWorker = this.#navigator!.serviceWorker;\n      if (isFunction(serviceWorker.removeEventListener)) {\n        serviceWorker.removeEventListener(\"controllerchange\", this.#controllerChangeHandler);\n      }\n    }\n\n    return this.#state.registration.unregister();\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
