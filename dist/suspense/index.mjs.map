{
  "version": 3,
  "sources": ["../../lib/suspense/index.ts"],
  "sourcesContent": ["import {\n  ValyrianComponent,\n  Vnode,\n  isVnodeComponent,\n  isPOJOComponent,\n  isComponent,\n  v,\n  Children,\n  current,\n  VnodeWithDom,\n  DomElement,\n  updateVnode\n} from \"valyrian.js\";\n\ntype SuspenseKey = string | number;\n\ntype SuspenseStore = {\n  status: 0 | 1 | 2;\n  value: any;\n  error: Error | null;\n  version: number;\n  promise: Promise<any[]> | null;\n};\n\nconst domToSuspenseStores = new WeakMap<DomElement, Map<SuspenseKey, SuspenseStore>>();\n\nfunction getSuspenseStore(dom: DomElement, key: SuspenseKey): SuspenseStore {\n  let stores = domToSuspenseStores.get(dom);\n  if (!stores) {\n    stores = new Map();\n    domToSuspenseStores.set(dom, stores);\n  }\n\n  let store = stores.get(key);\n  if (!store) {\n    store = {\n      status: 0,\n      value: null,\n      error: null,\n      version: 0,\n      promise: null\n    };\n    stores.set(key, store);\n  }\n\n  return store;\n}\n\nexport function Suspense(\n  {\n    key,\n    fallback,\n    error\n  }: {\n    key: string | number;\n    fallback: any | Vnode | ValyrianComponent;\n    error?: (e: Error) => any | Vnode | ValyrianComponent;\n  },\n  children: Children\n) {\n  if (key === undefined || key === null) {\n    throw new Error(\"Suspense requires a 'key' prop\");\n  }\n\n  return v(() => {\n    const hostVnode = current.vnode as VnodeWithDom;\n    if (!hostVnode || !hostVnode.dom) {\n      throw new Error(\"Suspense must be rendered inside a component\");\n    }\n\n    const hostDom = hostVnode.dom as DomElement;\n    const store = getSuspenseStore(hostDom, key);\n\n    if (store.status === 2 && store.error) {\n      if (error) {\n        return error(store.error);\n      }\n      return store.error.message;\n    }\n\n    if (store.status === 1) {\n      return store.value;\n    }\n\n    if (!store.promise) {\n      const version = ++store.version;\n\n      const promise = Promise.all(\n        children.map((child) => {\n          if (isVnodeComponent(child)) {\n            if (isPOJOComponent(child.tag)) {\n              return child.tag.view.bind(child.tag)(child.props || {}, child.children);\n            }\n\n            return child.tag(child.props || {}, child.children);\n          }\n\n          if (isPOJOComponent(child)) {\n            return child.view.bind(child)({}, []);\n          }\n\n          if (isComponent(child)) {\n            return child({}, []);\n          }\n\n          return child;\n        })\n      );\n\n      store.promise = promise;\n\n      promise\n        .then((newChildren) => {\n          if (store.version !== version) {\n            return;\n          }\n\n          store.status = 1;\n          store.value = newChildren;\n          store.error = null;\n          store.promise = null;\n\n          const vnodeToUpdate = hostDom.vnode as VnodeWithDom;\n          if (vnodeToUpdate) {\n            updateVnode(vnodeToUpdate);\n          }\n        })\n        .catch((e) => {\n          if (store.version !== version) {\n            return;\n          }\n\n          store.status = 2;\n          store.error = e instanceof Error ? e : new Error(String(e));\n          store.promise = null;\n\n          const vnodeToUpdate = hostDom.vnode as VnodeWithDom;\n          if (vnodeToUpdate) {\n            updateVnode(vnodeToUpdate);\n          }\n        });\n    }\n\n    return fallback;\n  }, {});\n}\n"],
  "mappings": ";AAAA;AAAA,EAGE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAEA;AAAA,EAGA;AAAA,OACK;AAYP,IAAM,sBAAsB,oBAAI,QAAqD;AAErF,SAAS,iBAAiB,KAAiB,KAAiC;AAC1E,MAAI,SAAS,oBAAoB,IAAI,GAAG;AACxC,MAAI,CAAC,QAAQ;AACX,aAAS,oBAAI,IAAI;AACjB,wBAAoB,IAAI,KAAK,MAAM;AAAA,EACrC;AAEA,MAAI,QAAQ,OAAO,IAAI,GAAG;AAC1B,MAAI,CAAC,OAAO;AACV,YAAQ;AAAA,MACN,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,OAAO;AAAA,MACP,SAAS;AAAA,MACT,SAAS;AAAA,IACX;AACA,WAAO,IAAI,KAAK,KAAK;AAAA,EACvB;AAEA,SAAO;AACT;AAEO,SAAS,SACd;AAAA,EACE;AAAA,EACA;AAAA,EACA;AACF,GAKA,UACA;AACA,MAAI,QAAQ,UAAa,QAAQ,MAAM;AACrC,UAAM,IAAI,MAAM,gCAAgC;AAAA,EAClD;AAEA,SAAO,EAAE,MAAM;AACb,UAAM,YAAY,QAAQ;AAC1B,QAAI,CAAC,aAAa,CAAC,UAAU,KAAK;AAChC,YAAM,IAAI,MAAM,8CAA8C;AAAA,IAChE;AAEA,UAAM,UAAU,UAAU;AAC1B,UAAM,QAAQ,iBAAiB,SAAS,GAAG;AAE3C,QAAI,MAAM,WAAW,KAAK,MAAM,OAAO;AACrC,UAAI,OAAO;AACT,eAAO,MAAM,MAAM,KAAK;AAAA,MAC1B;AACA,aAAO,MAAM,MAAM;AAAA,IACrB;AAEA,QAAI,MAAM,WAAW,GAAG;AACtB,aAAO,MAAM;AAAA,IACf;AAEA,QAAI,CAAC,MAAM,SAAS;AAClB,YAAM,UAAU,EAAE,MAAM;AAExB,YAAM,UAAU,QAAQ;AAAA,QACtB,SAAS,IAAI,CAAC,UAAU;AACtB,cAAI,iBAAiB,KAAK,GAAG;AAC3B,gBAAI,gBAAgB,MAAM,GAAG,GAAG;AAC9B,qBAAO,MAAM,IAAI,KAAK,KAAK,MAAM,GAAG,EAAE,MAAM,SAAS,CAAC,GAAG,MAAM,QAAQ;AAAA,YACzE;AAEA,mBAAO,MAAM,IAAI,MAAM,SAAS,CAAC,GAAG,MAAM,QAAQ;AAAA,UACpD;AAEA,cAAI,gBAAgB,KAAK,GAAG;AAC1B,mBAAO,MAAM,KAAK,KAAK,KAAK,EAAE,CAAC,GAAG,CAAC,CAAC;AAAA,UACtC;AAEA,cAAI,YAAY,KAAK,GAAG;AACtB,mBAAO,MAAM,CAAC,GAAG,CAAC,CAAC;AAAA,UACrB;AAEA,iBAAO;AAAA,QACT,CAAC;AAAA,MACH;AAEA,YAAM,UAAU;AAEhB,cACG,KAAK,CAAC,gBAAgB;AACrB,YAAI,MAAM,YAAY,SAAS;AAC7B;AAAA,QACF;AAEA,cAAM,SAAS;AACf,cAAM,QAAQ;AACd,cAAM,QAAQ;AACd,cAAM,UAAU;AAEhB,cAAM,gBAAgB,QAAQ;AAC9B,YAAI,eAAe;AACjB,sBAAY,aAAa;AAAA,QAC3B;AAAA,MACF,CAAC,EACA,MAAM,CAAC,MAAM;AACZ,YAAI,MAAM,YAAY,SAAS;AAC7B;AAAA,QACF;AAEA,cAAM,SAAS;AACf,cAAM,QAAQ,aAAa,QAAQ,IAAI,IAAI,MAAM,OAAO,CAAC,CAAC;AAC1D,cAAM,UAAU;AAEhB,cAAM,gBAAgB,QAAQ;AAC9B,YAAI,eAAe;AACjB,sBAAY,aAAa;AAAA,QAC3B;AAAA,MACF,CAAC;AAAA,IACL;AAEA,WAAO;AAAA,EACT,GAAG,CAAC,CAAC;AACP;",
  "names": []
}
