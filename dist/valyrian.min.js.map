{"version":3,"file":"valyrian.min.js","sources":["../lib/index.js"],"sourcesContent":["'use strict';\n\nfunction createVnode() {\n    return {\n        name: 'div',\n        props: {},\n        children: [],\n        dom: null,\n        isVnode: true,\n        isText: false,\n        nodeValue: null\n    };\n}\n\nfunction render(component, args, children) {\n    children = component.view.apply(component, args);\n    return Array.isArray(children) ? children : [children];\n}\n\nfunction dom2vnode($el, vnode) {\n    if ($el.nodeType === 3 || $el.nodeType === 1) {\n        vnode = createVnode();\n        vnode.name = $el.nodeName.toLowerCase();\n        vnode.dom = $el;\n\n        if ($el.nodeType === 3) {\n            vnode.nodeValue = $el.nodeValue;\n            vnode.isText = true;\n            return vnode;\n        }\n\n        vnode.dom.events = {};\n\n        Array.prototype.map.call($el.attributes, function (property) {\n            vnode.props[property.nodeName] = property.nodeValue;\n        });\n\n        Array.prototype.forEach.call($el.childNodes, function ($el) {\n            let childvnode = dom2vnode($el);\n            if (childvnode !== undefined) {\n                vnode.children.push(childvnode);\n            }\n        });\n\n        return vnode;\n    }\n}\n\nfunction getChildren(args, array, index, length, vnode) {\n    index = 0;\n    length = args.length;\n\n    for (; index < length; index++) {\n        if (args[index]) {\n            if (Array.isArray(args[index])) {\n                getChildren(args[index], array);\n                continue;\n            }\n\n            if (typeof args[index] === 'object' && (args[index].isVnode)) {\n                array.push(args[index]);\n                continue;\n            }\n\n            vnode = createVnode();\n            vnode.name = '#text';\n            vnode.isText = true;\n            vnode.nodeValue = args[index];\n\n            array.push(vnode);\n        }\n    }\n}\n\nfunction v(tagOrComponent, props, vnode, i) {\n    if (typeof tagOrComponent === 'string') {\n        vnode = createVnode();\n        vnode.name = tagOrComponent;\n\n        for (i in props) {\n            vnode.props[i] = props[i];\n        }\n\n        getChildren(v.utils.arguments2Array(arguments, 2), vnode.children);\n        return vnode;\n    }\n\n    if (typeof tagOrComponent === 'function') {\n        return Object.assign({view: tagOrComponent, isComponent: true}, props);\n    }\n\n    if (typeof tagOrComponent === 'object') {\n        if (tagOrComponent.isComponent) {\n            return render(tagOrComponent, v.utils.arguments2Array(arguments, 1));\n        }\n\n        if (typeof tagOrComponent.view === 'function') {\n            return Object.assign(tagOrComponent, {isComponent: true});\n        }\n    }\n}\n\nv.utils = {};\nv.utils.arguments2Array = function (args, start, arr, l) {\n    arr = [];\n    l = args.length;\n\n    if (start === undefined) {\n        start = 0;\n    }\n\n    for (; start < l; start++) {\n        arr.push(args[start]);\n    }\n\n    return arr;\n};\n\nv.is = {};\nv.is.node = typeof window === 'undefined';\nv.is.browser = !v.is.node;\nv.is.mounted = false;\n\nv.trust = function (htmlString) {\n    let div = document.createElement('div');\n    div.innerHTML = htmlString.trim();\n\n    return Array.prototype.map.call(div.childNodes, (item) => dom2vnode(item));\n};\n\nlet mountedComponent;\nlet oldTree;\nlet newTree;\nlet mainContainer;\n\nfunction lifecycleCall(vnode, methodName) {\n    if (\n        !vnode.isText &&\n        vnode.props !== undefined &&\n        vnode.props[methodName] !== undefined\n    ) {\n        return vnode.props[methodName](vnode);\n    }\n}\n\nfunction eventListener(e) {\n    e.currentTarget.events['on' + event.type](e);\n    v.update();\n}\n\nfunction patch($parent, newTree, oldTree, isSVG, max, newNode, oldNode, i, isNew, name) {\n    if (newTree.length === 0) {\n        $parent.textContent = '';\n        return;\n    }\n\n    max = newTree.length > oldTree.length ? newTree.length : oldTree.length;\n    i = 0;\n    for (; i < max; i++) {\n        newNode = newTree[i];\n        oldNode = oldTree[i];\n        isNew = !v.is.mounted;\n\n        if (newNode === undefined) { // Removed\n            lifecycleCall(oldNode, 'onremove');\n            $parent.removeChild(oldNode.dom);\n            continue;\n        }\n\n        isSVG = isSVG || newNode.name === 'svg';\n\n        if (oldNode === undefined) { // Added\n            lifecycleCall(newNode, 'oninit');\n            newNode.dom = newNode.isText ?\n                document.createTextNode(newNode.nodeValue) :\n                isSVG ?\n                    document.createElementNS(\"http://www.w3.org/2000/svg\", newNode.name) :\n                    document.createElement(newNode.name);\n            $parent.appendChild(newNode.dom);\n            if (newNode.isText) {\n                continue;\n            }\n            oldNode = {children: []};\n            isNew = true;\n        } else {\n            if (newNode.name !== oldNode.name) { // Replaced\n                lifecycleCall(newNode, 'oninit');\n                newNode.dom = newNode.isText ?\n                    document.createTextNode(newNode.nodeValue) :\n                    isSVG ?\n                        document.createElementNS(\"http://www.w3.org/2000/svg\", newNode.name) :\n                        document.createElement(newNode.name);\n\n                lifecycleCall(oldNode, 'onremove');\n                $parent.replaceChild(newNode.dom, oldNode.dom);\n                if (newNode.isText) {\n                    continue;\n                }\n                isNew = true;\n            } else { // Updated\n                newNode.dom = oldNode.dom;\n                if (newNode.isText) {\n                    newNode.dom.nodeValue = newNode.nodeValue;\n                    continue;\n                }\n            }\n        }\n\n        patch(newNode.dom, newNode.children, oldNode.children, isSVG);\n\n        // Update props\n        if (!isNew) {\n            for (name in oldNode.props) {\n                if (newNode.props[name] === undefined) {\n                    if (typeof oldNode.props[name] === 'function') {\n                        newNode.dom.removeEventListener(name.slice(2), eventListener);\n                        continue;\n                    }\n                    newNode.dom[name] = null;\n                    if (v.is.node) {\n                        newNode.dom.removeAttribute(name);\n                    }\n                }\n            }\n        }\n\n        for (name in newNode.props) {\n            if (\n                isNew ||\n                (newNode.props[name] !== oldNode.props[name])\n            ) {\n                if (typeof newNode.props[name] === 'function') {\n                    switch (name) {\n                        case 'oninit':\n                        case 'oncreate':\n                        case 'onupdate':\n                        case 'onremove':\n                            break;\n                        default:\n                            if (newNode.dom.events === undefined) {\n                                newNode.dom.events = {};\n                            }\n\n                            if (newNode.dom.events[name] === undefined) {\n                                newNode.dom.events[name] = newNode.props[name];\n                                newNode.dom.addEventListener(name.slice(2), eventListener);\n                            }\n                            break;\n                    }\n\n                    continue;\n                }\n\n                if (v.is.node) {\n                    newNode.dom.setAttribute(name, newNode.props[name]);\n                    continue;\n                }\n\n                newNode.dom[name] = newNode.props[name];\n            }\n        }\n\n        if (!v.is.mounted) {\n            lifecycleCall(newNode, 'oninit');\n            lifecycleCall(newNode, 'oncreate');\n        }\n\n        lifecycleCall(newNode, isNew ? 'oncreate' : 'onupdate');\n    }\n}\n\nlet isUpdating = false;\n\nv.update = function (args) {\n    args = v.utils.arguments2Array(arguments);\n    if (typeof args[0] === 'object' && args[0].isComponent) {\n        mountedComponent = args.shift();\n    }\n    return new Promise((resolve) => {\n        if (!isUpdating) {\n            isUpdating = true;\n            args.unshift(mountedComponent);\n            newTree = v.apply(v, args);\n            patch(mainContainer, newTree, oldTree);\n            oldTree = newTree;\n            isUpdating = false;\n            v.is.mounted = true;\n            resolve(mainContainer.innerHTML);\n        }\n    });\n};\n\nv.mount = function (container, component) {\n    mountedComponent = component;\n    mainContainer = v.is.node ? document.createElement('div') : typeof container === 'string' ? document.querySelectorAll(container)[0] : container;\n    oldTree = dom2vnode(mainContainer).children;\n    return v.update.apply(this, v.utils.arguments2Array(arguments, 2));\n};\n\n// Very simple plugin system\nlet plugins = [];\nv.use = function (plugin, options) {\n    if (plugins.indexOf(plugin) === -1) {\n        plugin(v, options);\n        plugins.push(plugin);\n    }\n    return v;\n};\n\n(v.is.node ? global : window).v = v;\n"],"names":["dom2vnode","$el","vnode","nodeType","name","props","children","dom","isVnode","isText","nodeValue","nodeName","toLowerCase","events","Array","prototype","map","call","attributes","property","forEach","childNodes","childvnode","undefined","push","v","tagOrComponent","i","getChildren","args","array","index","length","isArray","utils","arguments2Array","arguments","Object","assign","view","isComponent","component","apply","mountedComponent","oldTree","newTree","mainContainer","lifecycleCall","methodName","eventListener","e","currentTarget","event","type","update","start","arr","l","is","node","window","browser","mounted","trust","htmlString","div","document","createElement","innerHTML","trim","item","isUpdating","shift","Promise","resolve","unshift","patch","$parent","isSVG","max","newNode","oldNode","isNew","createTextNode","createElementNS","appendChild","replaceChild","removeEventListener","slice","removeAttribute","addEventListener","setAttribute","removeChild","textContent","mount","container","querySelectorAll","this","plugins","use","plugin","options","indexOf","global"],"mappings":"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"}