{"version":3,"file":"valyrian.min.js","sources":["../lib/patch.js","../lib/index.js"],"sourcesContent":["let plugin = function (v) {\n  let mountedComponent;\n  let oldTree;\n  let newTree;\n  let mainContainer;\n  let und;\n  let oncreate = 'oncreate';\n  let onupdate = 'onupdate';\n  let onremove = 'onremove';\n  let svgstr = 'http://www.w3.org/2000/svg';\n\n  function lifecycleCall(vnode, methodName, oldNode, l) {\n    if (vnode.props[methodName]) {\n      vnode.props[methodName](vnode, oldNode);\n    }\n\n    if (methodName === onremove) {\n      l = vnode.children.length;\n      while (l--) {\n        if (vnode.children[l].el) {\n          lifecycleCall(vnode.children[l], onremove);\n        }\n      }\n      vnode.children = [];\n    }\n  }\n\n  function eventListener(e) {\n    if (e.currentTarget.events['on' + e.type]) {\n      e.currentTarget.events['on' + e.type](e);\n    }\n    v.update();\n  }\n\n  function createElement(newNode, isSVG) {\n    newNode.dom = isSVG ? document.createElementNS(svgstr, newNode.name) : document.createElement(newNode.name);\n    newNode.dom.events = {};\n  }\n\n  // eslint-disable-next-line complexity, sonarjs/cognitive-complexity\n  function patch($parent, newTree, oldTree, isSVG, max, newNode, oldNode, i, isNew, name) {\n    if (newTree.length === 0) {\n      i = oldTree.length;\n\n      while (i--) {\n        if (oldTree[i].el) {\n          lifecycleCall(oldTree[i], onremove);\n        }\n      }\n\n      $parent.textContent = '';\n      return;\n    }\n\n    max = newTree.length > oldTree.length ? newTree.length : oldTree.length;\n    for (i = 0; i < max; i++) {\n      newNode = newTree[i];\n      oldNode = oldTree[i];\n\n      // Removed\n      if (newNode === und) {\n        if (oldNode !== und) {\n          if (oldNode.el) {\n            lifecycleCall(oldNode, onremove);\n          }\n          $parent.removeChild(oldNode.dom);\n        }\n        // Is text\n      } else if (newNode.el === und || !newNode.el) {\n        if (newNode.el === und) {\n          newTree[i] = newNode = {\n            isVnode: true,\n            nodeValue: newNode,\n            children: [],\n            el: false\n          };\n        }\n\n        // Added\n        if (oldNode === und) {\n          newNode.dom = document.createTextNode(newNode.nodeValue);\n          $parent.appendChild(newNode.dom);\n          // Replaced element\n        } else if (oldNode.el) {\n          newNode.dom = document.createTextNode(newNode.nodeValue);\n          lifecycleCall(oldNode, onremove);\n          $parent.replaceChild(newNode.dom, oldNode.dom);\n          // Replaced text\n        } else {\n          newNode.dom = oldNode.dom;\n          if (newNode.nodeValue !== oldNode.nodeValue) {\n            newNode.dom.nodeValue = newNode.nodeValue;\n          }\n        }\n      } else {\n        isNew = !v.is.mounted;\n\n        isSVG = isSVG || newNode.isSVG;\n\n        // Added\n        if (oldNode === und) {\n          createElement(newNode, isSVG);\n          $parent.appendChild(newNode.dom);\n          oldNode = { children: [], props: {} };\n          isNew = true;\n          // Replaced\n        } else if (newNode.name !== oldNode.name) {\n          createElement(newNode, isSVG);\n\n          lifecycleCall(oldNode, onremove);\n          $parent.replaceChild(newNode.dom, oldNode.dom);\n          isNew = true;\n          // Updated\n        } else {\n          newNode.dom = oldNode.dom;\n\n          for (name in oldNode.props) {\n            if (newNode.props[name] === und) {\n              if (typeof oldNode.props[name] === 'function') {\n                newNode.dom.removeEventListener(name.slice(2), eventListener);\n              } else if (v.is.browser && !isSVG && newNode.dom[name] !== und) {\n                newNode.dom[name] = null;\n              } else {\n                newNode.dom.removeAttribute(name);\n              }\n            }\n          }\n        }\n\n        // Update props\n        for (name in newNode.props) {\n          if (newNode.props[name] !== und) {\n            if (typeof newNode.props[name] === 'function') {\n              switch (name) {\n                case oncreate:\n                case onupdate:\n                case onremove:\n                  break;\n                default:\n                  if (!newNode.dom.events[name]) {\n                    newNode.dom.events[name] = newNode.props[name];\n                    newNode.dom.addEventListener(name.slice(2), eventListener);\n                  }\n                  break;\n              }\n            } else if (\n              v.is.browser &&\n              !isSVG &&\n              newNode.dom[name] !== und &&\n              newNode.props[name] !== newNode.dom[name]\n            ) {\n              newNode.dom[name] = newNode.props[name];\n            } else if (newNode.props[name] !== oldNode.props[name]) {\n              newNode.dom.setAttribute(name, newNode.props[name]);\n            }\n          }\n        }\n\n        lifecycleCall(newNode, isNew ? oncreate : onupdate, oldNode);\n\n        patch(newNode.dom, newNode.children, oldNode.children, isSVG);\n      }\n    }\n  }\n\n  // If use undom this serializes the dom to string html\n  function serialize(el, outer = true, i) {\n    if (el.nodeType === 3) {\n      return el.textContent;\n    }\n\n    let name = el.nodeName.toLowerCase();\n    let str = '';\n    let attr = el.attributes;\n    let child = el.childNodes;\n\n    if (outer) {\n      str += `<${name}`;\n      i = attr.length;\n      while (i--) {\n        str += ` ${attr[i].name}=\"${attr[i].value}\"`;\n      }\n\n      str += '>';\n    }\n\n    for (i = 0; i < child.length; i++) {\n      str += serialize(child[i]);\n    }\n\n    str += outer ? `</${name}>` : '';\n    return str;\n  }\n\n  v.update = function (args) {\n    args = v.utils.flat(arguments, 0, []);\n    if (args[0]) {\n      if (!args[0].view && typeof args[0] === 'function') {\n        args[0].view = args[0];\n      }\n\n      if (args[0].view) {\n        mountedComponent = args.shift();\n      }\n    }\n\n    if (!v.is.updating) {\n      v.is.updating = true;\n      args.unshift(mountedComponent);\n      newTree = v.apply(v, args);\n      patch(mainContainer, newTree, oldTree);\n      oldTree = newTree;\n      v.is.updating = false;\n      v.is.mounted = true;\n    }\n\n    if (v.is.node) {\n      return mainContainer.innerHTML;\n    }\n  };\n\n  v.mount = function (container) {\n    mainContainer = v.is.node\n      ? document.createElement('div')\n      : typeof container === 'string'\n        ? document.querySelectorAll(container)[0]\n        : container;\n\n    oldTree = v.utils.dom2vnode(mainContainer).children;\n\n    return v.update.apply(this, v.utils.flat(arguments, 1, []));\n  };\n};\n\nexport default plugin;\n","'use strict';\nimport Patch from './patch';\n\nfunction v(tagOrComponent, props, vnode, i, children) {\n  if (typeof tagOrComponent === 'string') {\n    vnode = {\n      name: tagOrComponent,\n      props: props || {},\n      children: [],\n      dom: null,\n      isVnode: true,\n      el: true,\n      isSVG: tagOrComponent === 'svg'\n    };\n\n    v.utils.flat(arguments, 2, vnode.children, true);\n    return vnode;\n  }\n\n  if (!tagOrComponent.view && typeof tagOrComponent === 'function') {\n    tagOrComponent.view = tagOrComponent;\n  }\n\n  if (tagOrComponent.view) {\n    children = tagOrComponent.view.apply(tagOrComponent, v.utils.flat(arguments, 1, []));\n    return Array.isArray(children) ? children : [children];\n  }\n}\n\n// This could be extended to do a deep clone\n// This mutates the component\nv.addState = function (component, state) {\n  Object.assign(component, { view: component }, state);\n};\n\nv.utils = {\n  flat: function (args, start, arr, notEmpty, l) {\n    l = args.length;\n\n    for (; start < l; start++) {\n      if (Array.isArray(args[start])) {\n        arr = v.utils.flat(args[start], 0, arr);\n        continue;\n      }\n      if (!notEmpty || (args[start] !== undefined && args[start] !== null)) {\n        arr.push(args[start]);\n      }\n    }\n\n    return arr;\n  },\n  dom2vnode($el, vnode, nt) {\n    nt = $el.nodeType;\n    if (nt === 3 || nt === 1) {\n      vnode = {\n        props: {},\n        children: [],\n        dom: $el,\n        isVnode: true,\n        el: true,\n        isSVG: false\n      };\n\n      if (nt === 3) {\n        vnode.nodeValue = $el.nodeValue;\n        vnode.el = false;\n        return vnode;\n      }\n\n      vnode.name = $el.nodeName.toLowerCase();\n\n      if (vnode.name === 'svg') {\n        vnode.isSVG = true;\n      }\n\n      vnode.dom.events = {};\n\n      Array.prototype.map.call($el.attributes, function (property) {\n        vnode.props[property.nodeName] = property.nodeValue;\n      });\n\n      Array.prototype.forEach.call($el.childNodes, function ($el) {\n        let childvnode = v.utils.dom2vnode($el);\n        if (childvnode) {\n          vnode.children.push(childvnode);\n        }\n      });\n\n      return vnode;\n    }\n  }\n};\n\nv.is = {\n  node: typeof window === 'undefined',\n  mounted: false,\n  updating: false\n};\nv.is.browser = !v.is.node;\n\n// NOTE: This does not work with undom for server side rendering\n// See: https://github.com/developit/undom/issues/7\nv.trust = function (htmlString) {\n  let div = document.createElement('div');\n  div.innerHTML = htmlString.trim();\n\n  return Array.prototype.map.call(div.childNodes, (item) => v.utils.dom2vnode(item));\n};\n\nlet plugins = [];\nv.use = function (plugin, options) {\n  if (plugins.indexOf(plugin) === -1) {\n    plugin(v, options);\n    plugins.push(plugin);\n  }\n  return v;\n};\n\nv.use(Patch);\n\n(v.is.node ? global : window).v = v;\n"],"names":["v","tagOrComponent","props","vnode","i","children","name","dom","isVnode","el","isSVG","utils","flat","arguments","view","apply","Array","isArray","addState","component","state","Object","assign","args","start","arr","notEmpty","l","length","undefined","push","[object Object]","$el","nt","nodeType","nodeValue","nodeName","toLowerCase","events","prototype","map","call","attributes","property","forEach","childNodes","childvnode","dom2vnode","is","node","window","mounted","updating","browser","trust","htmlString","div","document","createElement","innerHTML","trim","item","plugins","use","plugin","options","indexOf","mountedComponent","oldTree","newTree","mainContainer","und","oncreate","onupdate","onremove","svgstr","lifecycleCall","methodName","oldNode","eventListener","e","currentTarget","type","update","newNode","createElementNS","shift","unshift","patch","$parent","max","isNew","removeChild","appendChild","replaceChild","removeEventListener","slice","removeAttribute","addEventListener","setAttribute","createTextNode","textContent","mount","container","querySelectorAll","this","global"],"mappings":"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"}