(()=>{"use strict";var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.prototype.hasOwnProperty,o={};((t,r)=>{for(var n in r)e(t,n,{get:r[n],enumerable:!0})})(o,{Router:()=>h,RouterError:()=>d,mountRouter:()=>p,redirect:()=>f});var s,i=(s=o,((o,s,i,a)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let l of r(s))n.call(o,l)||l===i||e(o,l,{get:()=>s[l],enumerable:!(a=t(s,l))||a.enumerable});return o})(e({},"__esModule",{value:!0}),s)),a=require("valyrian.js");function l(e){let t=e.replace(/\/$/,"");return""===t&&(t="/"),t}var c,u=class{root={segment:"",children:new Map,isDynamic:!1};addRoute(e,t){const r="/"===e?[e]:e.split("/").filter(Boolean);let n=this.root;for(const e of r){const t=e.startsWith(":"),r=t?":":e;n.children.has(r)||n.children.set(r,{segment:e,children:new Map,isDynamic:t,paramKey:t?e.slice(1):void 0}),n=n.children.get(r)}n.middlewares=t}findRoute(e){const t=l(e),r="/"===t?[t]:t.split("/").filter(Boolean);let n=this.root;const o={},s=[],i=r.length;for(let e=0;e<i&&n;e++){const t=r[e];let i=!1;for(const[e,r]of n.children){if(e===t){n=r,i=!0;break}if(".*"!==t&&":"===e){n=r,o[r.paramKey]=t,i=!0;break}".*"!==e||i||s.push(...r.middlewares||[])}if(!i)return n.children.has(".*")?{middlewares:s,params:o}:null}const a=[...s,...n.middlewares||[]];return 0===a.length?null:{middlewares:a,params:o}}},d=class extends Error{status=500},h=class e{routeTree=new u;container=null;query={};options={};url="";path="";params={};matches=[];pathPrefix="";errorHandlers=new Map;constructor(e=""){this.pathPrefix=e}add(...t){const r=(n=t,Array.isArray(n)?n.flat(1/0):[n]);var n;const o=l(`${this.pathPrefix}${"string"==typeof r[0]?r.shift():"/.*"}`);if(1===r.length&&r[0]instanceof e){const e=r[0];for(const t of e.routes()){const r=`${o}${t}`;this.routeTree.addRoute(r,e.routeTree.findRoute(t).middlewares||[])}}else{if(r.some(t=>t instanceof e))throw new d("You cannot add middlewares when adding a subrouter.");if(r.some(e=>"function"!=typeof e))throw new d("All middlewares must be functions.");this.routeTree.addRoute(o,r)}return this}catch(...e){const t="number"==typeof e[0]||"string"==typeof e[0]||e[0].name.includes("Error")?e.shift():"generic";if("number"!=typeof t&&"string"!=typeof t&&!t.name.includes("Error"))throw new d("The condition must be a number, string or an instance of Error.");if(e.some(e=>"function"!=typeof e))throw new d("All middlewares must be functions.");let r=this.errorHandlers.get(t);return r||(r=[],this.errorHandlers.set(t,r)),r.push(...e),this}routes(){return this.getAllRoutes(this.routeTree.root,"")}async go(e,t){if(!e)return this.handleError(new d("The URL is empty."),t);if(/%[^0-9A-Fa-f]{2}/.test(e))return this.handleError(new d(`The URL ${e} is malformed.`));const r=l(`${this.pathPrefix}${e}`),n=r.split("?",2);this.url=r,this.query=function(e){const t=e?e.split("&"):[],r={};for(const e of t){const[t,n]=e.split("=",2);r[t]=!1===isNaN(Number(n))?Number(n):"true"===n||"false"!==n&&n}return r}(n[1]);const o=n[0].replace(/(.+)\/$/,"$1").split("#")[0];this.path=e;let s=this.routeTree.findRoute(o);if(!s||!s.middlewares){const e=o.split("/");for(;e.length>0;){e.pop();const t=this.routeTree.findRoute(e.join("/")+"/.*");if(t){s=t;break}}if(!s||!s.middlewares){const e=new d(`The URL ${r} was not found in the router's registered paths.`);return e.status=404,this.handleError(e,t)}}const{middlewares:i,params:c}=s;this.params=c;let u=await this.searchComponent(i,t);if(!1!==u){if(!u)return this.handleError(new d(`The URL ${r} did not return a valid component.`),t);if((0,a.isComponent)(t)||(0,a.isVnodeComponent)(t)){const e=(0,a.isVnodeComponent)(u)?u:(0,a.v)(u,{});(0,a.isVnodeComponent)(t)?(t.children.push(e),u=t):u=(0,a.v)(t,{},e)}return a.isNodeJs||window.location.pathname+window.location.search===r||window.history.pushState(null,"",r),this.container?(0,a.mount)(this.container,u):void 0}}getOnClickHandler(e){return t=>{0!==t.button||t.ctrlKey||t.metaKey||t.shiftKey||t.altKey||t.defaultPrevented||("string"==typeof e&&e.length>0&&this.go(e),t.preventDefault())}}getAllRoutes(e,t){const r=[];for(const[n,o]of e.children){const e=`${t}/${o.isDynamic?`:${o.paramKey}`:n}`.replace(/\/$/,"");o.middlewares&&r.push(e),r.push(...this.getAllRoutes(o,e))}return r}createRequest(){return{params:this.params,query:this.query,url:this.url,path:this.path,matches:this.matches,redirect:e=>this.go(e)}}getErrorConditionMiddlewares(e){for(const[t,r]of this.errorHandlers)if("number"!=typeof t&&"string"!=typeof t&&e instanceof t&&e.name===t.name)return r;for(const[t,r]of this.errorHandlers)if("number"==typeof t&&(e.status===t||e.code===t))return r;for(const[t,r]of this.errorHandlers)if("string"==typeof t&&(e.name===t||e.message.includes(t)))return r;return this.errorHandlers.get("generic")||!1}async handleError(e,t){const r=this.createRequest();let n=null;const o=this.getErrorConditionMiddlewares(e);if(!1===o)throw e;let s;try{for(const t of o){if(s=await t(r,e),void 0!==s&&((0,a.isComponent)(s)||(0,a.isVnodeComponent)(s))){n=s;break}if(!1===s)return}}catch(r){r.cause=e;let n=0;for(;r.cause;)n++;if(n>20)throw new d("Too many error causes. Possible circular error handling.");return this.handleError(r,t)}if(n){if((0,a.isComponent)(t)||(0,a.isVnodeComponent)(t)){const e=(0,a.isVnodeComponent)(n)?n:(0,a.v)(n,{});(0,a.isVnodeComponent)(t)?(t.children.push(e),n=t):n=(0,a.v)(t,{},e)}if(a.isNodeJs||window.location.pathname+window.location.search===this.url||window.history.pushState(null,"",this.url),this.container)return(0,a.mount)(this.container,n)}throw e}async searchComponent(e,t){const r=this.createRequest();let n;for(const o of e){try{n=await o(r)}catch(e){return this.handleError(e,t)}if(void 0!==n&&((0,a.isComponent)(n)||(0,a.isVnodeComponent)(n)))return n;if(!1===n)return!1}return n}};async function f(e,t,r=!1){if(c)return c(e,t,r);console.warn("Redirect function is not initialized. Please mount the router first.")}function p(e,t){if(t.container=e,c=t.go.bind(t),!a.isNodeJs){let e=function(){const e=(r=document.location.pathname,n=t.pathPrefix,l(r.replace(new RegExp(`^${n}`),"")));var r,n;t.go(e)};window.addEventListener("popstate",e,!1),e()}(0,a.directive)("route",(e,r)=>{(0,a.setAttribute)("href",e,r),(0,a.setAttribute)("onclick",t.getOnClickHandler(e),r)})}"undefined"!=typeof module?module.exports=i:self.ValyrianRouter=i})();//# sourceMappingURL=index.min.js.map