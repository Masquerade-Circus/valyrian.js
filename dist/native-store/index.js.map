{
  "version": 3,
  "sources": ["../../lib/native-store/index.ts"],
  "sourcesContent": ["import { isNodeJs } from \"valyrian.js\";\nimport { createContextScope, getContext, isServerContextActive, setContext } from \"valyrian.js/context\";\n\n/* eslint-disable no-console */\nexport enum StorageType {\n  // eslint-disable-next-line no-unused-vars\n  Session = \"session\",\n  // eslint-disable-next-line no-unused-vars\n  Local = \"local\"\n}\n\nexport interface NativeStorageInterface {\n  state: Record<string, any>;\n  // eslint-disable-next-line no-unused-vars\n  set(key: string, value: any): void;\n  // eslint-disable-next-line no-unused-vars\n  get(key: string): any;\n  // eslint-disable-next-line no-unused-vars\n  delete(key: string): void;\n  load(): void;\n  clear(): void;\n  cleanup(): void;\n}\n\nconst stores = new Map<string, NativeStorageInterface>();\nconst nativeStoreRegistryScope = createContextScope<Map<string, NativeStorageInterface>>(\"native-store.registry\");\n\nfunction getStoreRegistry() {\n  if (!isNodeJs || !isServerContextActive()) {\n    return stores;\n  }\n\n  let scopedStores = getContext(nativeStoreRegistryScope);\n  if (!scopedStores) {\n    scopedStores = new Map<string, NativeStorageInterface>();\n    setContext(nativeStoreRegistryScope, scopedStores);\n  }\n\n  return scopedStores;\n}\n\nfunction getStorage(storageType: StorageType) {\n  if (isNodeJs && typeof localStorage === \"undefined\") {\n    throw new Error(\n      `localStorage and sessionStorage are not available in Node.js, to use it in your project, you need to \"import \"valyrian.js/node\"`\n    );\n  }\n  return storageType === StorageType.Session ? sessionStorage : localStorage;\n}\n\nexport function createNativeStore<T>(\n  id: string,\n  definition: Record<string, any> = {},\n  storageType: StorageType = StorageType.Local,\n  reuseIfExist = false\n): NativeStorageInterface & T {\n  const nativeStore = getStorage(storageType);\n  const storeRegistry = getStoreRegistry();\n\n  if (storeRegistry.has(id)) {\n    if (reuseIfExist) {\n      // eslint-disable-next-line no-console\n      console.warn(`Store with key ${id} already exists and will be reused`);\n      return storeRegistry.get(id) as NativeStorageInterface & T;\n    } else {\n      throw new Error(`Store with key ${id} already exists`);\n    }\n  }\n\n  const Store: NativeStorageInterface = {\n    state: {},\n    set(key, value) {\n      try {\n        this.state[key] = value;\n        nativeStore.setItem(id, JSON.stringify(this.state));\n      } catch (e) {\n        console.error(\"Error setting item in storage:\", e);\n      }\n    },\n    get(key) {\n      if (Object.keys(this.state).length === 0) {\n        this.load();\n      }\n      return this.state[key];\n    },\n    delete(key) {\n      try {\n        Reflect.deleteProperty(this.state, key);\n        nativeStore.setItem(id, JSON.stringify(this.state));\n      } catch (e) {\n        console.error(\"Error deleting item in storage:\", e);\n      }\n    },\n    load() {\n      try {\n        const state = nativeStore.getItem(id);\n        if (!state) {\n          this.state = {};\n          nativeStore.setItem(id, JSON.stringify(this.state));\n          return;\n        }\n        this.state = JSON.parse(state);\n      } catch (e) {\n        console.error(\"Error loading state from storage:\", e);\n        this.state = {};\n      }\n    },\n    clear() {\n      try {\n        this.state = {};\n        nativeStore.removeItem(id);\n      } catch (e) {\n        console.error(\"Error clearing storage:\", e);\n      }\n    },\n    cleanup() {},\n    ...definition\n  };\n\n  let storageListener: ((e: StorageEvent) => void) | null = null;\n\n  if (!isNodeJs && storageType === StorageType.Local) {\n    storageListener = (e: StorageEvent) => {\n      if (e.key === id) {\n        try {\n          Store.state = e.newValue === null ? {} : JSON.parse(e.newValue);\n        } catch (err) {\n          console.error(`Error syncing store ${id} from storage event`, err);\n        }\n      }\n    };\n\n    window.addEventListener(\"storage\", storageListener);\n  }\n\n  Store.load();\n\n  storeRegistry.set(id, Store);\n\n  Store.cleanup = () => {\n    if (storageListener) {\n      window.removeEventListener(\"storage\", storageListener);\n      storageListener = null;\n    }\n    storeRegistry.delete(id);\n  };\n\n  return Store as NativeStorageInterface & T;\n}\n"],
  "mappings": "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",
  "names": ["StorageType"]
}
