(()=>{"use strict";var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,r=Object.prototype.hasOwnProperty,a={};((t,s)=>{for(var r in s)e(t,r,{get:s[r],enumerable:!0})})(a,{MutationHandle:()=>y,QueryClient:()=>f,QueryHandle:()=>d});var i,c=(i=a,((a,i,c,n)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let u of s(i))r.call(a,u)||u===c||e(a,u,{get:()=>i[u],enumerable:!(n=t(i,u))||n.enumerable});return a})(e({},"__esModule",{value:!0}),i)),n=require("valyrian.js/native-store");function u(e){return JSON.stringify(e)}function l(e,t){if(t.length>e.length)return!1;for(let s=0;s<t.length;s++)if(JSON.stringify(e[s])!==JSON.stringify(t[s]))return!1;return!0}function o(e){return Object.freeze({...e})}function h(e){const t=e&&"object"==typeof e?e:{},s=null!==t.error&&void 0!==t.error,r="idle"===(a=t.status)||"loading"===a||"success"===a||"error"===a?"loading"===t.status?"idle":t.status:t.success?"success":s?"error":"idle";var a;return{status:r,loading:!1,success:"success"===r,error:"error"===r?t.error??null:null,data:"data"in t?t.data??null:null,updatedAt:"number"==typeof t.updatedAt?t.updatedAt:0}}var d=class{#e;#t;#s;constructor(e,t,s){this.#e=e,this.#t=t,this.#s=s}get key(){return this.#e.key}get state(){return o(this.#e.state)}get data(){return this.#e.state.data}fetch(){return this.#t()}invalidate(){this.#s()}},y=class{#r;#a;#i;constructor(e,t,s){this.#r=e,this.#a=t,this.#i=s}get state(){return o(this.#r)}execute(e){return this.#a(e)}reset(){this.#i()}},f=class{#c;#n;#u=new Map;#l=new Set;#o;constructor(e={}){this.#c=e.staleTime??6e4,this.#n=e.cacheTime??6e5,this.#o=e.persist?(0,n.createNativeStore)(e.persistId||"valyrian-query",{},n.StorageType.Local,!0):null,this.#h()}#d(e){for(const t of this.#l)t(e)}#y(){if(!this.#o)return;const e=Array.from(this.#u.values()).map(e=>({key:e.key,hash:e.hash,state:e.state,staleTime:e.staleTime}));this.#o.set("cache",e)}#h(){if(!this.#o)return;const e=this.#o.get("cache");if(Array.isArray(e))for(const t of e){if(!t||"object"!=typeof t)continue;const e=t;if(!Array.isArray(e.key))continue;const s=e.key,r=u(s),a="number"==typeof e.staleTime&&e.staleTime>=0?e.staleTime:this.#c,i=h(e.state),c={key:s,hash:r,state:i,fetcher:()=>i.data,staleTime:a,promise:null,gcTimer:null};this.#u.set(r,c),this.#f(c)}}#f(e){e.gcTimer&&clearTimeout(e.gcTimer),e.gcTimer=setTimeout(()=>{this.#u.delete(e.hash),this.#d({type:"gc",key:e.key}),this.#y()},this.#n)}async#m(e){if(Date.now()-e.state.updatedAt<e.staleTime&&e.state.success)return e.state.data;if(e.promise)return e.promise;e.state.status="loading",e.state.loading=!0,e.state.success=!1,e.state.error=null,this.#d({type:"query:start",key:e.key,state:o(e.state)});const t=Promise.resolve(e.fetcher()).then(t=>(e.state.data=t,e.state.status="success",e.state.loading=!1,e.state.success=!0,e.state.error=null,e.state.updatedAt=Date.now(),this.#d({type:"query:success",key:e.key,state:o(e.state)}),this.#y(),this.#f(e),t)).catch(t=>{throw e.state.status="error",e.state.loading=!1,e.state.success=!1,e.state.error=t,this.#d({type:"query:error",key:e.key,state:o(e.state)}),this.#y(),t}).finally(()=>{e.promise=null});return e.promise=t,t}query(e){const t=e.key,s=u(t),r=e.staleTime??this.#c;if(this.#u.has(s)){const t=this.#u.get(s);t.fetcher=e.fetcher,t.staleTime=r}else this.#u.set(s,{key:t,hash:s,fetcher:e.fetcher,staleTime:r,promise:null,gcTimer:null,state:{status:"idle",loading:!1,success:!1,error:null,data:null,updatedAt:0}});const a=this.#u.get(s);return new d(a,()=>this.#m(a),()=>{a.state.updatedAt=0,this.#d({type:"query:invalidate",key:a.key,state:o(a.state)})})}mutation(e){const t={status:"idle",loading:!1,success:!1,error:null,data:null,updatedAt:0};return new y(t,async s=>{t.status="loading",t.loading=!0,t.success=!1,t.error=null,this.#d({type:"mutation:start",payload:s,state:o(t)});try{const r=await e.execute(s);return t.status="success",t.loading=!1,t.success=!0,t.data=r,t.updatedAt=Date.now(),e.onSuccess?.(r),this.#d({type:"mutation:success",payload:s,state:o(t)}),r}catch(r){throw t.status="error",t.loading=!1,t.success=!1,t.error=r,e.onError?.(r),this.#d({type:"mutation:error",payload:s,state:o(t)}),r}},()=>{t.status="idle",t.loading=!1,t.success=!1,t.error=null,t.data=null})}invalidate(e){for(const t of this.#u.values())l(t.key,e)&&(t.state.updatedAt=0,this.#d({type:"query:invalidate",key:t.key,state:o(t.state)}))}clear(){for(const e of this.#u.values())e.gcTimer&&clearTimeout(e.gcTimer);this.#u.clear(),this.#d({type:"cache:clear"}),this.#y()}on(e,t){return"change"!==e?()=>{}:(this.#l.add(t),()=>this.#l.delete(t))}off(e,t){"change"===e&&this.#l.delete(t)}};"undefined"!=typeof module?module.exports=c:self.ValyrianQuery=c})();//# sourceMappingURL=index.min.js.map