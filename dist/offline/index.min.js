(()=>{"use strict";var t=Object.defineProperty,e=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.prototype.hasOwnProperty,r={};((e,s)=>{for(var i in s)t(e,i,{get:s[i],enumerable:!0})})(r,{OfflineQueue:()=>f});var n,a=(n=r,((r,n,a,h)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let o of s(n))i.call(r,o)||o===a||t(r,o,{get:()=>n[o],enumerable:!(h=e(n,o))||h.enumerable});return r})(t({},"__esModule",{value:!0}),n)),h=require("valyrian.js/network"),o=require("valyrian.js/native-store"),l=require("valyrian.js/utils");function c(t){return Object.freeze({...t})}var f=class{#t;#e;#s;#i;#r;#n=null;#a;#h;#o;#l;#c={change:new Set,"sync:success":new Set,"sync:error":new Set};constructor(t){if(!t.network)throw new TypeError("OfflineQueue requires options.network");this.#t=t.network,this.#e=t.maxRetries??5,this.#s=t.isRetryable||(()=>!0),this.#i=t.backoff||{},this.#r=t.handler;const e="session"===t.storage?o.StorageType.Session:o.StorageType.Local;this.#a=(0,o.createNativeStore)(t.id,{},e,!0),this.#h=this.#a.get("pending")||[],this.#o=this.#a.get("failed")||[],this.#l={pending:this.#h.length,failed:this.#o.length,syncing:!1,lastSyncAt:this.#a.get("lastSyncAt")||null,lastError:this.#a.get("lastError")||null},this.#n=this.#t.on(h.NetworkEvent.ONLINE,()=>{this.sync()})}#f(t,e){for(const s of this.#c[t])s(e);if("change"!==t){const t=c(this.#l);for(const e of this.#c.change)e(t)}}#d(){this.#a.set("pending",this.#h),this.#a.set("failed",this.#o),this.#a.set("lastSyncAt",this.#l.lastSyncAt),this.#a.set("lastError",this.#l.lastError),this.#l.pending=this.#h.length,this.#l.failed=this.#o.length}#g(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}async#u(t){try{return await this.#r(t),{ok:!0}}catch(s){if(t.retries+=1,t.lastError=function(t){return(0,l.isString)(t)?t:t instanceof Error&&t.message.length>0?t.message:"Unknown error"}(s),!this.#s(s)||t.retries>this.#e)return{ok:!1,failed:!0,error:s};const i=function(t,e={}){const s=e.strategy||"exponential",i=e.baseMs??1e3,r=e.maxMs??3e4;return"linear"===s?Math.min(r,i*t):Math.min(r,i*Math.pow(2,t-1))}(t.retries,this.#i);return await(e=i,new Promise(t=>setTimeout(t,e))),{ok:!1,failed:!1,error:s}}var e}state(){return c(this.#l)}pending(){return this.#h.map(t=>({...t}))}failed(){return this.#o.map(t=>({...t}))}enqueue(t){this.#h.push({...t,id:this.#g(),createdAt:Date.now(),retries:0}),this.#d(),this.#f("change",c(this.#l))}async sync(){if(!this.#l.syncing&&this.#t.getNetworkStatus().online){this.#l.syncing=!0,this.#f("change",c(this.#l));try{for(;this.#h.length>0;){const t=this.#h[0],e=await this.#u(t);if(e.ok)this.#h.shift(),this.#l.lastError=null,this.#l.lastSyncAt=Date.now(),this.#d(),this.#f("sync:success",{...t});else{if(!e.failed){this.#l.lastError=t.lastError||null,this.#d();break}this.#h.shift(),this.#o.push(t),this.#l.lastError=t.lastError||null,this.#d(),this.#f("sync:error",{operation:{...t},error:e.error})}}}finally{this.#l.syncing=!1,this.#d(),this.#f("change",c(this.#l))}}}retryOne(t){const e=this.#o.findIndex(e=>e.id===t);if(-1===e)return;const s=this.#o.splice(e,1)[0];s.retries=0,this.#h.push(s),this.#d(),this.#f("change",c(this.#l))}retryAll(){for(;this.#o.length>0;){const t=this.#o.shift();t&&(t.retries=0,this.#h.push(t))}this.#d(),this.#f("change",c(this.#l))}discardFailed(){this.#o.splice(0,this.#o.length),this.#d(),this.#f("change",c(this.#l))}on(t,e){return this.#c[t].add(e),()=>this.off(t,e)}off(t,e){this.#c[t].delete(e)}destroy(){this.#n?.(),this.#n=null,this.#c.change.clear(),this.#c["sync:success"].clear(),this.#c["sync:error"].clear()}};"undefined"!=typeof module?module.exports=a:self.ValyrianOffline=a})();//# sourceMappingURL=index.min.js.map