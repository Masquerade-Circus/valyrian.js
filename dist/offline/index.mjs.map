{
  "version": 3,
  "sources": ["../../lib/offline/index.ts"],
  "sourcesContent": ["import { NetworkEvent, NetworkManager } from \"valyrian.js/network\";\nimport { createNativeStore, StorageType } from \"valyrian.js/native-store\";\nimport { isString } from \"valyrian.js/utils\";\n\nexport type RetryStrategy = \"exponential\" | \"linear\";\n\nexport type BackoffConfig = {\n  strategy?: RetryStrategy;\n  baseMs?: number;\n  maxMs?: number;\n};\n\nexport type OfflineOperation = {\n  id: string;\n  type: string;\n  payload?: unknown;\n  retries: number;\n  createdAt: number;\n  lastError?: string;\n};\n\nexport type QueueState = {\n  pending: number;\n  failed: number;\n  syncing: boolean;\n  lastSyncAt: number | null;\n  lastError: string | null;\n};\n\nexport type OfflineQueueOptions = {\n  id: string;\n  network: NetworkManager;\n  storage?: \"local\" | \"session\";\n  handler: (operation: OfflineOperation) => Promise<unknown>;\n  isRetryable?: (error: unknown) => boolean;\n  backoff?: BackoffConfig;\n  maxRetries?: number;\n};\n\ntype OfflineQueueEventMap = {\n  change: Readonly<QueueState>;\n  \"sync:success\": OfflineOperation;\n  \"sync:error\": { operation: OfflineOperation; error: unknown };\n};\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nfunction toErrorMessage(error: unknown) {\n  if (isString(error)) {\n    return error;\n  }\n\n  if (error instanceof Error && error.message.length > 0) {\n    return error.message;\n  }\n\n  return \"Unknown error\";\n}\n\nfunction calculateBackoffDelay(retries: number, backoff: BackoffConfig = {}) {\n  const strategy = backoff.strategy || \"exponential\";\n  const baseMs = backoff.baseMs ?? 1000;\n  const maxMs = backoff.maxMs ?? 30000;\n\n  if (strategy === \"linear\") {\n    return Math.min(maxMs, baseMs * retries);\n  }\n\n  return Math.min(maxMs, baseMs * Math.pow(2, retries - 1));\n}\n\nfunction cloneState(state: QueueState) {\n  return Object.freeze({ ...state });\n}\n\nexport class OfflineQueue {\n  #network: NetworkManager;\n  #maxRetries: number;\n  #retryable: (error: unknown) => boolean;\n  #backoff: BackoffConfig;\n  #handler: (operation: OfflineOperation) => Promise<unknown>;\n  #offOnline: (() => void) | null = null;\n\n  #store;\n  #pending: OfflineOperation[];\n  #failed: OfflineOperation[];\n  #state: QueueState;\n\n  #destroyed = false;\n\n  #listeners: {\n    [K in keyof OfflineQueueEventMap]: Set<(payload: OfflineQueueEventMap[K]) => void>;\n  } = {\n    change: new Set(),\n    \"sync:success\": new Set(),\n    \"sync:error\": new Set()\n  };\n\n  constructor(options: OfflineQueueOptions) {\n    if (!options.network) {\n      throw new TypeError(\"OfflineQueue requires options.network\");\n    }\n\n    this.#network = options.network;\n    this.#maxRetries = options.maxRetries ?? 5;\n    this.#retryable = options.isRetryable || (() => true);\n    this.#backoff = options.backoff || {};\n    this.#handler = options.handler;\n\n    const storageType = options.storage === \"session\" ? StorageType.Session : StorageType.Local;\n    this.#store = createNativeStore(options.id, {}, storageType, true);\n\n    this.#pending = (this.#store.get(\"pending\") || []) as OfflineOperation[];\n    this.#failed = (this.#store.get(\"failed\") || []) as OfflineOperation[];\n\n    this.#state = {\n      pending: this.#pending.length,\n      failed: this.#failed.length,\n      syncing: false,\n      lastSyncAt: this.#store.get(\"lastSyncAt\") || null,\n      lastError: this.#store.get(\"lastError\") || null\n    };\n\n    this.#offOnline = this.#network.on(NetworkEvent.ONLINE, () => {\n      void this.sync();\n    });\n  }\n\n  #emit<K extends keyof OfflineQueueEventMap>(event: K, payload: OfflineQueueEventMap[K]) {\n    for (const listener of this.#listeners[event]) {\n      listener(payload);\n    }\n\n    if (event !== \"change\") {\n      const stateSnapshot = cloneState(this.#state);\n      for (const listener of this.#listeners.change) {\n        listener(stateSnapshot);\n      }\n    }\n  }\n\n  #persist() {\n    this.#store.set(\"pending\", this.#pending);\n    this.#store.set(\"failed\", this.#failed);\n    this.#store.set(\"lastSyncAt\", this.#state.lastSyncAt);\n    this.#store.set(\"lastError\", this.#state.lastError);\n\n    this.#state.pending = this.#pending.length;\n    this.#state.failed = this.#failed.length;\n  }\n\n  #createId() {\n    return `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n  }\n\n  async #syncOne(operation: OfflineOperation) {\n    try {\n      await this.#handler(operation);\n      return { ok: true as const };\n    } catch (error) {\n      operation.retries += 1;\n      operation.lastError = toErrorMessage(error);\n\n      if (!this.#retryable(error) || operation.retries > this.#maxRetries) {\n        return { ok: false as const, failed: true as const, error };\n      }\n\n      const delay = calculateBackoffDelay(operation.retries, this.#backoff);\n      await sleep(delay);\n      return { ok: false as const, failed: false as const, error };\n    }\n  }\n\n  state() {\n    return cloneState(this.#state);\n  }\n\n  pending() {\n    return this.#pending.map((operation) => ({ ...operation }));\n  }\n\n  failed() {\n    return this.#failed.map((operation) => ({ ...operation }));\n  }\n\n  enqueue(operation: Omit<OfflineOperation, \"id\" | \"createdAt\" | \"retries\">) {\n    this.#pending.push({\n      ...operation,\n      id: this.#createId(),\n      createdAt: Date.now(),\n      retries: 0\n    });\n\n    this.#persist();\n    this.#emit(\"change\", cloneState(this.#state));\n  }\n\n  async sync() {\n    if (this.#destroyed || this.#state.syncing) {\n      return;\n    }\n\n    if (!this.#network.getNetworkStatus().online) {\n      return;\n    }\n\n    this.#state.syncing = true;\n    this.#emit(\"change\", cloneState(this.#state));\n\n    try {\n      while (this.#pending.length > 0 && !this.#destroyed) {\n        const operation = this.#pending[0];\n        const result = await this.#syncOne(operation);\n\n        if (result.ok) {\n          this.#pending.shift();\n          this.#state.lastError = null;\n          this.#state.lastSyncAt = Date.now();\n          this.#persist();\n          this.#emit(\"sync:success\", { ...operation });\n          continue;\n        }\n\n        if (result.failed) {\n          this.#pending.shift();\n          this.#failed.push(operation);\n          this.#state.lastError = operation.lastError || null;\n          this.#persist();\n          this.#emit(\"sync:error\", { operation: { ...operation }, error: result.error });\n          continue;\n        }\n\n        this.#state.lastError = operation.lastError || null;\n        this.#persist();\n        break;\n      }\n    } finally {\n      this.#state.syncing = false;\n      this.#persist();\n      this.#emit(\"change\", cloneState(this.#state));\n    }\n  }\n\n  retryOne(id: string) {\n    const index = this.#failed.findIndex((operation) => operation.id === id);\n    if (index === -1) {\n      return;\n    }\n\n    const operation = this.#failed.splice(index, 1)[0];\n    operation.retries = 0;\n    this.#pending.push(operation);\n    this.#persist();\n    this.#emit(\"change\", cloneState(this.#state));\n  }\n\n  retryAll() {\n    while (this.#failed.length > 0) {\n      const operation = this.#failed.shift();\n      if (!operation) {\n        continue;\n      }\n\n      operation.retries = 0;\n      this.#pending.push(operation);\n    }\n\n    this.#persist();\n    this.#emit(\"change\", cloneState(this.#state));\n  }\n\n  discardFailed() {\n    this.#failed.splice(0, this.#failed.length);\n    this.#persist();\n    this.#emit(\"change\", cloneState(this.#state));\n  }\n\n  on<K extends keyof OfflineQueueEventMap>(\n    event: K,\n    callback: (payload: OfflineQueueEventMap[K]) => void\n  ) {\n    this.#listeners[event].add(callback);\n    return () => this.off(event, callback);\n  }\n\n  off<K extends keyof OfflineQueueEventMap>(\n    event: K,\n    callback: (payload: OfflineQueueEventMap[K]) => void\n  ) {\n    this.#listeners[event].delete(callback);\n  }\n\n  destroy() {\n    this.#destroyed = true;\n    this.#offOnline?.();\n    this.#offOnline = null;\n\n    this.#listeners.change.clear();\n    this.#listeners[\"sync:success\"].clear();\n    this.#listeners[\"sync:error\"].clear();\n  }\n}\n"],
  "mappings": "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",
  "names": ["operation"]
}
