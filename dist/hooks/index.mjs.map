{
  "version": 3,
  "sources": ["../../lib/hooks/index.ts"],
  "sourcesContent": ["import { Component, POJOComponent, current, directive, onCleanup, onUnmount, debouncedUpdate } from \"valyrian.js\";\nimport { hasChanged } from \"valyrian.js/utils\";\n\nexport type Hook = any;\n\nexport interface HookDefinition {\n  onCreate: (...args: any[]) => any;\n  onUpdate?: (hook: Hook, ...args: any[]) => any;\n  onCleanup?: (hook: Hook) => any;\n  onRemove?: (hook: Hook) => any;\n  returnValue?: (hook: Hook) => any;\n}\n\nexport interface CreateHook {\n  (HookDefinition: HookDefinition): (...args: any[]) => any;\n}\n\ntype HookCalls = {\n  hooks: Hook[];\n  hook_calls: number;\n};\n\nconst componentToHooksWeakMap = new WeakMap<Component | POJOComponent, HookCalls>();\n\nexport const createHook = function createHook({\n  onCreate,\n  onUpdate: onUpdateHook,\n  onCleanup: onCleanupHook,\n  onRemove,\n  returnValue\n}: HookDefinition): Hook {\n  return (...args: any[]) => {\n    const component = current.component as Component | POJOComponent;\n    let HookCalls = componentToHooksWeakMap.get(component);\n\n    if (!HookCalls) {\n      HookCalls = { hooks: [], hook_calls: -1 };\n      componentToHooksWeakMap.set(component, HookCalls);\n      onUnmount(() => componentToHooksWeakMap.delete(component));\n    }\n\n    onCleanup(() => ((HookCalls as HookCalls).hook_calls = -1));\n\n    let hook = HookCalls.hooks[++HookCalls.hook_calls];\n    if (hook) {\n      onUpdateHook?.(hook, ...args);\n    } else {\n      hook = onCreate(...args);\n      HookCalls.hooks.push(hook);\n      onRemove && onUnmount(() => onRemove(hook));\n    }\n\n    onCleanupHook && onCleanup(() => onCleanupHook(hook));\n    return returnValue ? returnValue(hook) : hook;\n  };\n} as unknown as CreateHook;\n\n// Use state hook\nexport const useState = createHook({\n  onCreate: (value) => {\n    let state = value;\n    function get() {\n      return state;\n    }\n\n    function set(newValue: any) {\n      if (current.event && !current.event.defaultPrevented) {\n        current.event.preventDefault();\n      }\n\n      const resolvedValue = typeof newValue === \"function\" ? newValue(state) : newValue;\n\n      if (hasChanged(state, resolvedValue)) {\n        state = resolvedValue;\n        debouncedUpdate();\n      }\n    }\n\n    return [get, set];\n  }\n});\n\nexport const useEffect = createHook({\n  onCreate: (effect: Function, changes: any[]) => {\n    const hook: {\n      effect: Function;\n      prev: any[];\n      onRemove?: Function;\n      onCleanup?: Function;\n    } = { effect, prev: [] };\n    // on unmount\n    if (changes === null) {\n      hook.onRemove = effect;\n      return hook;\n    }\n\n    // on create\n    hook.prev = changes;\n    hook.onCleanup = hook.effect();\n    return hook;\n  },\n  onUpdate: (hook, effect, changes) => {\n    // on update\n    if (typeof changes === \"undefined\") {\n      hook.prev = changes;\n      if (typeof hook.onCleanup === \"function\") {\n        hook.onCleanup();\n      }\n      hook.onCleanup = hook.effect();\n      return;\n    }\n\n    if (Array.isArray(changes) && changes.length === 0) {\n      // Si las dependencias son un array vac\u00EDo, no se debe volver a ejecutar.\n      return;\n    }\n\n    // on update if there are changes\n    if (Array.isArray(changes) && hasChanged(hook.prev, changes)) {\n      hook.prev = changes;\n      if (typeof hook.onCleanup === \"function\") {\n        hook.onCleanup();\n      }\n      hook.onCleanup = hook.effect();\n    }\n  },\n  onRemove: (hook) => {\n    if (typeof hook.onCleanup === \"function\") {\n      hook.onCleanup();\n    }\n    if (typeof hook.onRemove === \"function\") {\n      hook.onRemove();\n    }\n  }\n});\n\nexport const useRef = createHook({\n  onCreate: (initialValue) => {\n    directive(\"ref\", (ref, vnode) => {\n      ref.current = vnode.dom;\n    });\n    return { current: initialValue };\n  }\n});\n\nexport const useCallback = createHook({\n  onCreate: (callback, changes) => {\n    return { callback, changes };\n  },\n  onUpdate: (hook, callback, changes) => {\n    if (hasChanged(hook.changes, changes)) {\n      hook.changes = changes;\n      hook.callback = callback;\n    }\n  },\n  returnValue: (hook) => hook.callback\n});\n\nexport const useMemo = createHook({\n  onCreate: (callback, changes) => {\n    return { callback, changes, value: callback() };\n  },\n  onUpdate: (hook, callback, changes) => {\n    if (hasChanged(hook.changes, changes)) {\n      hook.changes = changes;\n      hook.value = callback();\n    }\n  },\n  returnValue: (hook) => hook.value\n});\n"],
  "mappings": "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",
  "names": ["createHook"]
}
