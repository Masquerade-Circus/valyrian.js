{
  "version": 3,
  "sources": ["../../lib/hooks/index.ts"],
  "sourcesContent": ["import { Component, POJOComponent, VnodeWithDom, current, directive, onCleanup, onUnmount, update } from \"valyrian.js\";\n\ninterface CurrentOnPatch {\n  component: Component | POJOComponent;\n  vnode: VnodeWithDom;\n  oldVnode: VnodeWithDom;\n}\n\nexport type Hook = any;\n\nexport interface HookDefinition {\n  // eslint-disable-next-line no-unused-vars\n  onCreate: (...args: any[]) => any;\n  // eslint-disable-next-line no-unused-vars\n  onUpdate?: (hook: Hook, ...args: any[]) => any;\n  // eslint-disable-next-line no-unused-vars\n  onCleanup?: (hook: Hook) => any;\n  // eslint-disable-next-line no-unused-vars\n  onRemove?: (hook: Hook) => any;\n  // eslint-disable-next-line no-unused-vars\n  returnValue?: (hook: Hook) => any;\n}\n\nexport interface CreateHook {\n  // eslint-disable-next-line no-unused-vars\n  (HookDefinition: HookDefinition): (...args: any[]) => any;\n}\n\nexport const createHook = function createHook({\n  onCreate,\n  onUpdate: onUpdateHook,\n  onCleanup: onCleanupHook,\n  onRemove,\n  returnValue\n}: HookDefinition): Hook {\n  return (...args: any[]) => {\n    let { component, vnode } = current as CurrentOnPatch;\n\n    let hook: any = null;\n\n    if (vnode) {\n      // Init the components array for the current vnode\n      if (!vnode.components) {\n        vnode.components = [];\n      }\n\n      if (vnode.components.indexOf(component) === -1) {\n        vnode.hook_calls = -1;\n        vnode.components.push(component);\n        if (!component.hooks) {\n          component.hooks = [];\n          onUnmount(() => Reflect.deleteProperty(component, \"hooks\"));\n        }\n      }\n\n      hook = component.hooks[++vnode.hook_calls];\n    }\n\n    // If the hook doesn't exist, create it\n    if (!hook) {\n      // create a new hook\n      hook = onCreate(...args);\n\n      if (vnode) {\n        // Add the hook to the component\n        component.hooks.push(hook);\n      }\n\n      // if we have a onRemove hook, add it to the onUnmount set\n      if (onRemove) {\n        // Add the hook to the onRemove array\n        onUnmount(() => onRemove(hook));\n      }\n    } else {\n      if (onUpdateHook) {\n        onUpdateHook(hook, ...args);\n      }\n    }\n\n    // If we have an onCleanup function, add it to the cleanup set\n    if (onCleanupHook) {\n      // Add the hook to the onCleanup set\n      onCleanup(() => onCleanupHook(hook));\n    }\n\n    // If we have a returnValue function, call it and return the result instead of the hook\n    if (returnValue) {\n      return returnValue(hook);\n    }\n\n    // Return the hook\n    return hook;\n  };\n} as unknown as CreateHook;\n\nlet updateTimeout: any;\nfunction delayedUpdate() {\n  clearTimeout(updateTimeout);\n  updateTimeout = setTimeout(update);\n}\n\n// Use state hook\nexport const useState = createHook({\n  onCreate: (value) => {\n    function get() {\n      return value;\n    }\n    get.value = value;\n    get.toJSON = get.valueOf = get;\n    get.toString = () => `${value}`;\n\n    function set(newValue: any) {\n      // Prevent default event if it exists\n      if (current.event) {\n        current.event.preventDefault();\n      }\n\n      if (value !== newValue) {\n        value = newValue;\n        get.value = newValue;\n        delayedUpdate();\n      }\n    }\n\n    return [get, set];\n  }\n});\n\n// Effect hook\nexport const useEffect = createHook({\n  onCreate: (effect: Function, changes: any[]) => {\n    let hook: {\n      effect: Function;\n      prev: any[];\n      onRemove?: Function;\n      onCleanup?: Function;\n    } = { effect, prev: [] };\n    // on unmount\n    if (changes === null) {\n      hook.onRemove = effect;\n      return hook;\n    }\n\n    // on create\n    hook.prev = changes;\n    hook.onCleanup = hook.effect();\n    return hook;\n  },\n  onUpdate: (hook, effect, changes) => {\n    // on update\n    if (typeof changes === \"undefined\") {\n      hook.prev = changes;\n      if (typeof hook.onCleanup === \"function\") {\n        hook.onCleanup();\n      }\n      hook.onCleanup = hook.effect();\n      return;\n    }\n\n    // on update if there are changes\n    if (Array.isArray(changes)) {\n      for (let i = 0, l = changes.length; i < l; i++) {\n        if (changes[i] !== hook.prev[i]) {\n          hook.prev = changes;\n          if (typeof hook.onCleanup === \"function\") {\n            hook.onCleanup();\n          }\n          hook.onCleanup = hook.effect();\n          return;\n        }\n      }\n    }\n  },\n  onRemove: (hook) => {\n    if (typeof hook.onCleanup === \"function\") {\n      hook.onCleanup();\n    }\n    if (typeof hook.onRemove === \"function\") {\n      hook.onRemove();\n    }\n  }\n});\n\nexport const useRef = createHook({\n  onCreate: (initialValue) => {\n    directive(\"ref\", (ref, vnode) => {\n      ref.current = vnode.dom;\n    });\n    return { current: initialValue };\n  }\n});\n\nexport const useCallback = createHook({\n  onCreate: (callback, changes) => {\n    callback();\n    return { callback, changes };\n  },\n  onUpdate: (hook, callback, changes) => {\n    for (let i = 0, l = changes.length; i < l; i++) {\n      if (changes[i] !== hook.changes[i]) {\n        hook.changes = changes;\n        hook.callback();\n        return;\n      }\n    }\n  }\n});\n\nexport const useMemo = createHook({\n  onCreate: (callback, changes) => {\n    return { callback, changes, value: callback() };\n  },\n  onUpdate: (hook, callback, changes) => {\n    for (let i = 0, l = changes.length; i < l; i++) {\n      if (changes[i] !== hook.changes[i]) {\n        hook.changes = changes;\n        hook.value = callback();\n        return;\n      }\n    }\n  },\n  returnValue: (hook) => {\n    return hook.value;\n  }\n});\n"],
  "mappings": "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",
  "names": ["createHook"]
}
