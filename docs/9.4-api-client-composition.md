# 9.4. API Client Composition

Use this recipe when your app talks to multiple backend domains (auth, billing, users) and you want shared policies without shared mutable leakage.

Prerequisites:

- [./4.2.1-request.md](./4.2.1-request.md)
- [./7.2-isomorphic-networking-and-storage.md](./7.2-isomorphic-networking-and-storage.md)

## Goal

1. Define one per-request root client.
2. Derive domain clients from that root.
3. Keep common headers/plugins centralized.
4. Keep domain-specific behavior isolated.

## Browser or Single-Context Composition

```ts
import { request } from "valyrian.js/request";

function createApiClients(token: string) {
  const rootApi = request.new("", {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    }
  });

  const requestIdPlugin = rootApi.use({
    request(ctx) {
      ctx.options.headers["X-Request-Id"] = crypto.randomUUID();
      return ctx;
    }
  });

  const authApi = rootApi.new("/api/auth");
  const usersApi = rootApi.new("/api/users");
  const billingApi = rootApi.new("/api/billing");

  return {
    authApi,
    usersApi,
    billingApi,
    destroy() {
      rootApi.eject(requestIdPlugin);
    }
  };
}
```

Notes:

- Clients created with `new(...)` inherit parent plugins/options.
- Domain-specific settings can still be applied per client with `setOption(...)`.

## Per-Request SSR Composition

In Node.js SSR, create clients inside each `ServerStorage.run(...)` request scope.

```ts
import "valyrian.js/node";
import { ServerStorage } from "valyrian.js/node";
import { request } from "valyrian.js/request";

app.get("*", (req, res, next) => {
  ServerStorage.run(() => {
    void (async () => {
      const nodeOrigin = `${req.protocol}://${req.get("host")}`;

      const rootApi = request.new("", {
        headers: {
          Cookie: req.headers.cookie || "",
          Authorization: req.headers.authorization || "",
          "Content-Type": "application/json"
        },
        urls: {
          base: "",
          node: nodeOrigin
        }
      });

      const usersApi = rootApi.new("/api/users");
      const billingApi = rootApi.new("/api/billing");

      const user = await usersApi.get("/me");
      const invoice = await billingApi.get("/latest");

      res.json({ user, invoice });
    })().catch(next);
  });
});
```

## Guardrails

1. Do not keep request-scoped clients in module-level singletons on the server.
2. Keep auth/session headers at the request root client, not hardcoded in domain clients.
3. Prefer one root per incoming request, then branch with `new(...)`.
